
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>API Reference - VQGAN JAX/Flax Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="VQGAN JAX/Flax Docs" class="md-header__button md-logo" aria-label="VQGAN JAX/Flax Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            VQGAN JAX/Flax Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/WolodjaZ/jax-vqgan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="VQGAN JAX/Flax Docs" class="md-nav__button md-logo" aria-label="VQGAN JAX/Flax Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    VQGAN JAX/Flax Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/WolodjaZ/jax-vqgan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to Docs 👋
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        Tutorials 🙇
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        How-To Guides 📚
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        API Reference
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config" class="md-nav__link">
    modules.config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DataConfig" class="md-nav__link">
    DataConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DataParams" class="md-nav__link">
    DataParams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DiscConfig" class="md-nav__link">
    DiscConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.LoadConfig" class="md-nav__link">
    LoadConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.TrainConfig" class="md-nav__link">
    TrainConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.VQGANConfig" class="md-nav__link">
    VQGANConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#losses" class="md-nav__link">
    Losses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses" class="md-nav__link">
    modules.losses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.combo_loss" class="md-nav__link">
    combo_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.disc_loss_hinge" class="md-nav__link">
    disc_loss_hinge()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.disc_loss_vanilla" class="md-nav__link">
    disc_loss_vanilla()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.l1_loss" class="md-nav__link">
    l1_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.l2_loss" class="md-nav__link">
    l2_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.mape_loss" class="md-nav__link">
    mape_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models" class="md-nav__link">
    modules.models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.AttnBlock" class="md-nav__link">
    AttnBlock
  </a>
  
    <nav class="md-nav" aria-label="AttnBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.AttnBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Decoder" class="md-nav__link">
    Decoder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Downsample" class="md-nav__link">
    Downsample
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.DownsamplingBlock" class="md-nav__link">
    DownsamplingBlock
  </a>
  
    <nav class="md-nav" aria-label="DownsamplingBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.DownsamplingBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Encoder" class="md-nav__link">
    Encoder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.MidBlock" class="md-nav__link">
    MidBlock
  </a>
  
    <nav class="md-nav" aria-label="MidBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.MidBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.ResNetBlock" class="md-nav__link">
    ResNetBlock
  </a>
  
    <nav class="md-nav" aria-label="ResNetBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.ResNetBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Upsample" class="md-nav__link">
    Upsample
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.UpsamplingBlock" class="md-nav__link">
    UpsamplingBlock
  </a>
  
    <nav class="md-nav" aria-label="UpsamplingBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.UpsamplingBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    Training
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training" class="md-nav__link">
    modules.training
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.GenerateCallback" class="md-nav__link">
    GenerateCallback
  </a>
  
    <nav class="md-nav" aria-label="GenerateCallback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.GenerateCallback.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainStateDisc" class="md-nav__link">
    TrainStateDisc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainerModule" class="md-nav__link">
    TrainerModule
  </a>
  
    <nav class="md-nav" aria-label="TrainerModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.checkpoint_exists" class="md-nav__link">
    checkpoint_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.create_functions" class="md-nav__link">
    create_functions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.create_train_state" class="md-nav__link">
    create_train_state()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.eval_model" class="md-nav__link">
    eval_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.eval_step" class="md-nav__link">
    eval_step()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.init_optimizer" class="md-nav__link">
    init_optimizer()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.push_model_to_hub" class="md-nav__link">
    push_model_to_hub()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.save_model" class="md-nav__link">
    save_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_epoch" class="md-nav__link">
    train_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_model" class="md-nav__link">
    train_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_step" class="md-nav__link">
    train_step()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan" class="md-nav__link">
    TrainerVQGan
  </a>
  
    <nav class="md-nav" aria-label="TrainerVQGan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.checkpoint_exists" class="md-nav__link">
    checkpoint_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.create_functions" class="md-nav__link">
    create_functions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.create_train_stat_full" class="md-nav__link">
    create_train_stat_full()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.init_optimizer" class="md-nav__link">
    init_optimizer()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.save_model" class="md-nav__link">
    save_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.temperature_scheduling" class="md-nav__link">
    temperature_scheduling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.train_epoch" class="md-nav__link">
    train_epoch()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    Utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils" class="md-nav__link">
    modules.utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset" class="md-nav__link">
    BaseDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.get_dataset" class="md-nav__link">
    get_dataset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.DataLoader" class="md-nav__link">
    DataLoader
  </a>
  
    <nav class="md-nav" aria-label="DataLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.DummyDataset" class="md-nav__link">
    DummyDataset
  </a>
  
    <nav class="md-nav" aria-label="DummyDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.DummyDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.TensorflowDataset" class="md-nav__link">
    TensorflowDataset
  </a>
  
    <nav class="md-nav" aria-label="TensorflowDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.TensorflowDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.VQGanFeatureExtractor" class="md-nav__link">
    VQGanFeatureExtractor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor" class="md-nav__link">
    VQGanImageProcessor
  </a>
  
    <nav class="md-nav" aria-label="VQGanImageProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.normalize" class="md-nav__link">
    normalize()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.preprocess" class="md-nav__link">
    preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.rescale" class="md-nav__link">
    rescale()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.resize" class="md-nav__link">
    resize()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.make_img_grid" class="md-nav__link">
    make_img_grid()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.post_processing" class="md-nav__link">
    post_processing()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.set_seed" class="md-nav__link">
    set_seed()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vqgan" class="md-nav__link">
    VQGAN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan" class="md-nav__link">
    modules.vqgan
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.GumbelQuantize" class="md-nav__link">
    GumbelQuantize
  </a>
  
    <nav class="md-nav" aria-label="GumbelQuantize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.GumbelQuantize.get_codebook_entry" class="md-nav__link">
    get_codebook_entry()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.NLayerDiscriminator" class="md-nav__link">
    NLayerDiscriminator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel" class="md-nav__link">
    VQGANPreTrainedModel
  </a>
  
    <nav class="md-nav" aria-label="VQGANPreTrainedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.decode" class="md-nav__link">
    decode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.decode_code" class="md-nav__link">
    decode_code()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.encode" class="md-nav__link">
    encode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.init_weights" class="md-nav__link">
    init_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.update_temperature" class="md-nav__link">
    update_temperature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQGanDiscriminator" class="md-nav__link">
    VQGanDiscriminator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQModel" class="md-nav__link">
    VQModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule" class="md-nav__link">
    VQModule
  </a>
  
    <nav class="md-nav" aria-label="VQModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.decode" class="md-nav__link">
    decode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.decode_code" class="md-nav__link">
    decode_code()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.encode" class="md-nav__link">
    encode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.update_temperature" class="md-nav__link">
    update_temperature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VectorQuantizer" class="md-nav__link">
    VectorQuantizer
  </a>
  
    <nav class="md-nav" aria-label="VectorQuantizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VectorQuantizer.get_codebook_entry" class="md-nav__link">
    get_codebook_entry()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../explanation/" class="md-nav__link">
        Explanation 🤯
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        Changelog ⏳
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config" class="md-nav__link">
    modules.config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DataConfig" class="md-nav__link">
    DataConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DataParams" class="md-nav__link">
    DataParams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.DiscConfig" class="md-nav__link">
    DiscConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.LoadConfig" class="md-nav__link">
    LoadConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.TrainConfig" class="md-nav__link">
    TrainConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.config.VQGANConfig" class="md-nav__link">
    VQGANConfig
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#losses" class="md-nav__link">
    Losses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses" class="md-nav__link">
    modules.losses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.combo_loss" class="md-nav__link">
    combo_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.disc_loss_hinge" class="md-nav__link">
    disc_loss_hinge()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.disc_loss_vanilla" class="md-nav__link">
    disc_loss_vanilla()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.l1_loss" class="md-nav__link">
    l1_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.l2_loss" class="md-nav__link">
    l2_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.losses.mape_loss" class="md-nav__link">
    mape_loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models" class="md-nav__link">
    modules.models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.AttnBlock" class="md-nav__link">
    AttnBlock
  </a>
  
    <nav class="md-nav" aria-label="AttnBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.AttnBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Decoder" class="md-nav__link">
    Decoder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Downsample" class="md-nav__link">
    Downsample
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.DownsamplingBlock" class="md-nav__link">
    DownsamplingBlock
  </a>
  
    <nav class="md-nav" aria-label="DownsamplingBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.DownsamplingBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Encoder" class="md-nav__link">
    Encoder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.MidBlock" class="md-nav__link">
    MidBlock
  </a>
  
    <nav class="md-nav" aria-label="MidBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.MidBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.ResNetBlock" class="md-nav__link">
    ResNetBlock
  </a>
  
    <nav class="md-nav" aria-label="ResNetBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.ResNetBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.Upsample" class="md-nav__link">
    Upsample
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.models.UpsamplingBlock" class="md-nav__link">
    UpsamplingBlock
  </a>
  
    <nav class="md-nav" aria-label="UpsamplingBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.models.UpsamplingBlock.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    Training
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training" class="md-nav__link">
    modules.training
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.GenerateCallback" class="md-nav__link">
    GenerateCallback
  </a>
  
    <nav class="md-nav" aria-label="GenerateCallback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.GenerateCallback.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainStateDisc" class="md-nav__link">
    TrainStateDisc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainerModule" class="md-nav__link">
    TrainerModule
  </a>
  
    <nav class="md-nav" aria-label="TrainerModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.checkpoint_exists" class="md-nav__link">
    checkpoint_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.create_functions" class="md-nav__link">
    create_functions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.create_train_state" class="md-nav__link">
    create_train_state()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.eval_model" class="md-nav__link">
    eval_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.eval_step" class="md-nav__link">
    eval_step()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.init_optimizer" class="md-nav__link">
    init_optimizer()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.push_model_to_hub" class="md-nav__link">
    push_model_to_hub()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.save_model" class="md-nav__link">
    save_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_epoch" class="md-nav__link">
    train_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_model" class="md-nav__link">
    train_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerModule.train_step" class="md-nav__link">
    train_step()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan" class="md-nav__link">
    TrainerVQGan
  </a>
  
    <nav class="md-nav" aria-label="TrainerVQGan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.checkpoint_exists" class="md-nav__link">
    checkpoint_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.create_functions" class="md-nav__link">
    create_functions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.create_train_stat_full" class="md-nav__link">
    create_train_stat_full()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.init_optimizer" class="md-nav__link">
    init_optimizer()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.save_model" class="md-nav__link">
    save_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.temperature_scheduling" class="md-nav__link">
    temperature_scheduling()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.training.TrainerVQGan.train_epoch" class="md-nav__link">
    train_epoch()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    Utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils" class="md-nav__link">
    modules.utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset" class="md-nav__link">
    BaseDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.get_dataset" class="md-nav__link">
    get_dataset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.BaseDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.DataLoader" class="md-nav__link">
    DataLoader
  </a>
  
    <nav class="md-nav" aria-label="DataLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.DataLoader.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.DummyDataset" class="md-nav__link">
    DummyDataset
  </a>
  
    <nav class="md-nav" aria-label="DummyDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.DummyDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.TensorflowDataset" class="md-nav__link">
    TensorflowDataset
  </a>
  
    <nav class="md-nav" aria-label="TensorflowDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.TensorflowDataset.load_dataset" class="md-nav__link">
    load_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.VQGanFeatureExtractor" class="md-nav__link">
    VQGanFeatureExtractor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor" class="md-nav__link">
    VQGanImageProcessor
  </a>
  
    <nav class="md-nav" aria-label="VQGanImageProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.normalize" class="md-nav__link">
    normalize()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.preprocess" class="md-nav__link">
    preprocess()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.rescale" class="md-nav__link">
    rescale()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.utils.VQGanImageProcessor.resize" class="md-nav__link">
    resize()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.make_img_grid" class="md-nav__link">
    make_img_grid()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.post_processing" class="md-nav__link">
    post_processing()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.utils.set_seed" class="md-nav__link">
    set_seed()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vqgan" class="md-nav__link">
    VQGAN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan" class="md-nav__link">
    modules.vqgan
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.GumbelQuantize" class="md-nav__link">
    GumbelQuantize
  </a>
  
    <nav class="md-nav" aria-label="GumbelQuantize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.GumbelQuantize.get_codebook_entry" class="md-nav__link">
    get_codebook_entry()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.NLayerDiscriminator" class="md-nav__link">
    NLayerDiscriminator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel" class="md-nav__link">
    VQGANPreTrainedModel
  </a>
  
    <nav class="md-nav" aria-label="VQGANPreTrainedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.decode" class="md-nav__link">
    decode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.decode_code" class="md-nav__link">
    decode_code()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.encode" class="md-nav__link">
    encode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.init_weights" class="md-nav__link">
    init_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQGANPreTrainedModel.update_temperature" class="md-nav__link">
    update_temperature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQGanDiscriminator" class="md-nav__link">
    VQGanDiscriminator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQModel" class="md-nav__link">
    VQModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule" class="md-nav__link">
    VQModule
  </a>
  
    <nav class="md-nav" aria-label="VQModule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.decode" class="md-nav__link">
    decode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.decode_code" class="md-nav__link">
    decode_code()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.encode" class="md-nav__link">
    encode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.setup" class="md-nav__link">
    setup()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VQModule.update_temperature" class="md-nav__link">
    update_temperature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules.vqgan.VectorQuantizer" class="md-nav__link">
    VectorQuantizer
  </a>
  
    <nav class="md-nav" aria-label="VectorQuantizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modules.vqgan.VectorQuantizer.get_codebook_entry" class="md-nav__link">
    get_codebook_entry()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/WolodjaZ/jax-vqgan/edit/master/docs/reference.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="api-reference">API Reference</h1>
<p>Structure:</p>
<ul>
<li><a href="#api-reference">API Reference</a></li>
<li><a href="#config">Config</a></li>
<li><a href="#losses">Losses</a></li>
<li><a href="#models">Models</a></li>
<li><a href="#training">Training</a></li>
<li><a href="#utils">Utils</a></li>
<li><a href="#vqgan">VQGAN</a></li>
</ul>
<h2 id="config">Config</h2>


<div class="doc doc-object doc-module">


<a id="modules.config"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.config.DataConfig" class="doc doc-heading">
        <code>DataConfig</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>Data configuration class.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train_params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.DataParams" href="#modules.config.DataParams">DataParams</a></code>
          </td>
          <td><p>training data parameters. Check DataParams for more details.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>test_params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.DataParams" href="#modules.config.DataParams">DataParams</a></code>
          </td>
          <td><p>testing data parameters. Check DataParams for more details.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the dataset to use. Currently only supports "voc".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dataset_root</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>root directory of the dataset.</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>transform</code></td>
          <td>
                <code>optional, dict</code>
          </td>
          <td><p>transform to apply to the dataset. Default None for no transf.
Transform dict comes from albumentations library. Check albumentations for more details.
Loading transform should proceed with albumentations.from_dict method.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>size of image width and height.</p></td>
          <td>
                <code>224</code>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DataConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Data configuration class.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        train_params (DataParams): training data parameters. Check DataParams for more details.</span>
<span class="sd">        test_params (DataParams): testing data parameters. Check DataParams for more details.</span>
<span class="sd">        dataset_name (str): name of the dataset to use. Currently only supports &quot;voc&quot;.</span>
<span class="sd">        dataset_root (str): root directory of the dataset.</span>
<span class="sd">        transform (optional, dict): transform to apply to the dataset. Default None for no transf.</span>
<span class="sd">            Transform dict comes from albumentations library. Check albumentations for more details.</span>
<span class="sd">            Loading transform should proceed with albumentations.from_dict method.</span>
<span class="sd">        size (int): size of image width and height.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train_params</span><span class="p">:</span> <span class="n">DataParams</span>
    <span class="n">test_params</span><span class="p">:</span> <span class="n">DataParams</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">dataset_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set train_params and test_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_params</span> <span class="o">=</span> <span class="n">DataParams</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">train_params</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_params</span> <span class="o">=</span> <span class="n">DataParams</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">test_params</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.config.DataParams" class="doc doc-heading">
        <code>DataParams</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>Train and test data parameters.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>batch size for training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>shuffle</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to shuffle the dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DataParams</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Train and test data parameters.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        batch_size (int): batch size for training.</span>
<span class="sd">        shuffle (bool): whether to shuffle the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.config.DiscConfig" class="doc doc-heading">
        <code>DiscConfig</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="transformers.PretrainedConfig">PretrainedConfig</span></code></p>

  
      <p>Configuration class to store the configuration of a Discriminator model.
Dataclass for storing is based on <code>PretrainedConfig</code> from <code>transformers</code> package.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_last_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>last dimension of the input sample in Discriminator.</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
        <tr>
          <td><code>output_last_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>last dimension of the output sample in Discriminator.</p></td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>resolution</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>resolution of the input image (256x256).</p></td>
          <td>
                <code>256</code>
          </td>
        </tr>
        <tr>
          <td><code>ndf</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of filters in the first layer of Discriminator.</p></td>
          <td>
                <code>64</code>
          </td>
        </tr>
        <tr>
          <td><code>n_layers</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of layers in Discriminator.</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DiscConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration class to store the configuration of a Discriminator model.</span>
<span class="sd">    Dataclass for storing is based on `PretrainedConfig` from `transformers` package.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_last_dim (int): last dimension of the input sample in Discriminator.</span>
<span class="sd">        output_last_dim (int): last dimension of the output sample in Discriminator.</span>
<span class="sd">        resolution (int): resolution of the input image (256x256).</span>
<span class="sd">        ndf (int): number of filters in the first layer of Discriminator.</span>
<span class="sd">        n_layers (int): number of layers in Discriminator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_last_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">output_last_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">ndf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_last_dim</span> <span class="o">=</span> <span class="n">input_last_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_last_dim</span> <span class="o">=</span> <span class="n">output_last_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndf</span> <span class="o">=</span> <span class="n">ndf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.config.LoadConfig" class="doc doc-heading">
        <code>LoadConfig</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>Load configuration class to store the configuration of a train model and data.
Main configuration class to be used for training.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.DataConfig" href="#modules.config.DataConfig">DataConfig</a></code>
          </td>
          <td><p>data configuration.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>data</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.TrainConfig" href="#modules.config.TrainConfig">TrainConfig</a></code>
          </td>
          <td><p>training configuration.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LoadConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load configuration class to store the configuration of a train model and data.</span>
<span class="sd">    Main configuration class to be used for training.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        train (DataConfig): data configuration.</span>
<span class="sd">        data (TrainConfig): training configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train</span><span class="p">:</span> <span class="n">TrainConfig</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">DataConfig</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">TrainConfig</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">TrainConfig</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DataConfig</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DataConfig</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="c1"># set resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">disc_hparams</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">model_hparams</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.config.TrainConfig" class="doc doc-heading">
        <code>TrainConfig</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">

  
      <p>Configuration class to store the configuration of a train model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the model to train. Used for saving and logging.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_hparams</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>model hyperparameters. Check VQGANConfig for more details.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>disc_hparams</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.DiscConfig" href="#modules.config.DiscConfig">DiscConfig</a></code>
          </td>
          <td><p>discriminator hyperparameters.
Check DiscConfig for more details.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>save_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>directory to save the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>log_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>directory to save the logs for tensorboard.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>check_val_every_n_epoch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of epochs to run validation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>log_img_every_n_epoch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of epochs to log images.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_shape</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[int, int, int]</code>
          </td>
          <td><p>shape of the input image (H, W, C).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>codebook_weight</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>weight for the codebook loss (Quantizer part).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>monitor</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>metric to monitor for saving best model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>recon_loss</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>reconstruction loss to use. Can be one of <code>l1</code>, <code>l2</code>, <code>comb</code>, <code>mape</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>disc_loss</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>discriminator loss to use. Can be <code>vanilla</code> or <code>hinge</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>disc_weight</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>weight for the discriminator loss.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_epochs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of epochs to train.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>dtype to use for training.
Supported: <code>float32</code>, <code>float16</code>, <code>float16</code>, <code>bfloat16</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>distributed</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to use distributed training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>seed</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>seed for random number generation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>optimizer</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>optimizer to use for training. Structure needs to be
optax Optimizer (Check optax for more details) with '<strong>target</strong>' parameter,
for specifing optax optimizer, and 'kwargs' parameter for passing to optimizer.
check config_test.yaml for example.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>optimizer_disc</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>optimizer to use for discriminator training. Similar to optimizer.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>disc_start</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of epochs to past to start using the discriminator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temp_scheduler</code></td>
          <td>
                <code>optional</code>
          </td>
          <td><p>temperature scheduler to use for training. Similar to optimizer
but uses optax scheduler with '<strong>target</strong>' parameter, for specifing optax scheduler.
if None, then no scheduler is used. Check config_test.yaml for example.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TrainConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Configuration class to store the configuration of a train model.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        model_name (str): name of the model to train. Used for saving and logging.</span>
<span class="sd">        model_hparams (VQGANConfig): model hyperparameters. Check VQGANConfig for more details.</span>
<span class="sd">        disc_hparams (DiscConfig): discriminator hyperparameters.</span>
<span class="sd">            Check DiscConfig for more details.</span>
<span class="sd">        save_dir (str): directory to save the model.</span>
<span class="sd">        log_dir (str): directory to save the logs for tensorboard.</span>
<span class="sd">        check_val_every_n_epoch (int): number of epochs to run validation.</span>
<span class="sd">        log_img_every_n_epoch (int): number of epochs to log images.</span>
<span class="sd">        input_shape (Tuple[int, int, int]): shape of the input image (H, W, C).</span>
<span class="sd">        codebook_weight (float): weight for the codebook loss (Quantizer part).</span>
<span class="sd">        monitor (str): metric to monitor for saving best model.</span>
<span class="sd">        recon_loss (str): reconstruction loss to use. Can be one of `l1`, `l2`, `comb`, `mape`.</span>
<span class="sd">        disc_loss (str): discriminator loss to use. Can be `vanilla` or `hinge`.</span>
<span class="sd">        disc_weight (float): weight for the discriminator loss.</span>
<span class="sd">        num_epochs (int): number of epochs to train.</span>
<span class="sd">        dtype (str): dtype to use for training.</span>
<span class="sd">            Supported: `float32`, `float16`, `float16`, `bfloat16`.</span>
<span class="sd">        distributed (bool): whether to use distributed training.</span>
<span class="sd">        seed (int): seed for random number generation.</span>
<span class="sd">        optimizer (str): optimizer to use for training. Structure needs to be</span>
<span class="sd">            optax Optimizer (Check optax for more details) with &#39;__target__&#39; parameter,</span>
<span class="sd">            for specifing optax optimizer, and &#39;kwargs&#39; parameter for passing to optimizer.</span>
<span class="sd">            check config_test.yaml for example.</span>
<span class="sd">        optimizer_disc (str): optimizer to use for discriminator training. Similar to optimizer.</span>
<span class="sd">        disc_start (int): number of epochs to past to start using the discriminator.</span>
<span class="sd">        temp_scheduler (optional): temperature scheduler to use for training. Similar to optimizer</span>
<span class="sd">            but uses optax scheduler with &#39;__target__&#39; parameter, for specifing optax scheduler.</span>
<span class="sd">            if None, then no scheduler is used. Check config_test.yaml for example.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model_hparams</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">disc_hparams</span><span class="p">:</span> <span class="n">DiscConfig</span>
    <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">check_val_every_n_epoch</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">log_img_every_n_epoch</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">codebook_weight</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">monitor</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">recon_loss</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">disc_loss</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">disc_weight</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span>
    <span class="n">optimizer_disc</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span>
    <span class="n">disc_start</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">temp_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># load model hparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_hparams</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">VQGANConfig</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_hparams</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_hparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">VQGANConfig</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_hparams</span><span class="p">,</span> <span class="n">VQGANConfig</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;model_hparams could not create VQGANConfig&quot;</span><span class="p">)</span>
        <span class="c1"># load disc hparams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc_hparams</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DiscConfig</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_hparams</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_hparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DiscConfig</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_hparams</span><span class="p">,</span> <span class="n">DiscConfig</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;disc_hparams could not create DiscConfig&quot;</span><span class="p">)</span>
        <span class="c1"># conver shape list to tuple shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input_shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="si">}</span><span class="s2"> should be of length 3&quot;</span><span class="p">)</span>
        <span class="c1"># set dtype</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float64&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float16&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bfloat16&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Invalid dtype </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"></span>
<span class="s2">                             expected one of float64, float32, float16, bfloat16&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="c1"># instantiate the optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;optimizer should be optax GradientTransformation dict to instantiate&quot;</span><span class="p">)</span>
        <span class="c1"># instantiate the optimizer for discriminator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_disc</span> <span class="o">=</span> <span class="n">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_disc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_disc</span><span class="p">,</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;optimizer_disc should be optax GradientTransformation dict to instantiate&quot;</span>
            <span class="p">)</span>
        <span class="c1"># if optimizer is a dict, instantiate it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;temp_scheduler should be a callable or None&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.config.VQGANConfig" class="doc doc-heading">
        <code>VQGANConfig</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="transformers.PretrainedConfig">PretrainedConfig</span></code></p>

  
      <p>Configuration class to store the configuration of a VQGAN model.
Dataclass for storing is based on <code>PretrainedConfig</code> from <code>transformers</code> package.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of channels.</p></td>
          <td>
                <code>128</code>
          </td>
        </tr>
        <tr>
          <td><code>out_ch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of output channels (RGB).</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of input channels (RGB).</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
        <tr>
          <td><code>num_res_blocks</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of residual blocks.</p></td>
          <td>
                <code>2</code>
          </td>
        </tr>
        <tr>
          <td><code>resolution</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>resolution of the input image (256x256).</p></td>
          <td>
                <code>256</code>
          </td>
        </tr>
        <tr>
          <td><code>z_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of channels in the latent space.</p></td>
          <td>
                <code>256</code>
          </td>
        </tr>
        <tr>
          <td><code>ch_mult</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[int]</code>
          </td>
          <td><p>channel multiplier for each layer.</p></td>
          <td>
                <code>tuple([1, 1, 2, 2, 4])</code>
          </td>
        </tr>
        <tr>
          <td><code>attn_resolutions</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[int]</code>
          </td>
          <td><p>resolutions at which to apply attention.</p></td>
          <td>
                <code>(16)</code>
          </td>
        </tr>
        <tr>
          <td><code>n_embed</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of embeddings, unique codes in the latent space.</p></td>
          <td>
                <code>1024</code>
          </td>
        </tr>
        <tr>
          <td><code>embed_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>dimension of embedding from Encoder.</p></td>
          <td>
                <code>256</code>
          </td>
        </tr>
        <tr>
          <td><code>dropout</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>dropout rate.</p></td>
          <td>
                <code>0.0</code>
          </td>
        </tr>
        <tr>
          <td><code>double_z</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to double the latent space for.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>resamp_with_conv</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to use convolutions for upsampling.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>use_gumbel</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to use gumbel softmax for quantization.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>gumb_temp</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>temperature for gumbel softmax.</p></td>
          <td>
                <code>1.0</code>
          </td>
        </tr>
        <tr>
          <td><code>act_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>activation function name to use.</p></td>
          <td>
                <code>&#39;swish&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>give_pre_end</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to give the pre-end layer for the decoder.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>kwargs</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>keyword arguments passed along to the super class.</p></td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQGANConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration class to store the configuration of a VQGAN model.</span>
<span class="sd">    Dataclass for storing is based on `PretrainedConfig` from `transformers` package.</span>

<span class="sd">    Args:</span>
<span class="sd">        ch (int): number of channels.</span>
<span class="sd">        out_ch (int): number of output channels (RGB).</span>
<span class="sd">        in_channels (int): number of input channels (RGB).</span>
<span class="sd">        num_res_blocks (int): number of residual blocks.</span>
<span class="sd">        resolution (int): resolution of the input image (256x256).</span>
<span class="sd">        z_channels (int): number of channels in the latent space.</span>
<span class="sd">        ch_mult (Tuple[int]): channel multiplier for each layer.</span>
<span class="sd">        attn_resolutions (Tuple[int]): resolutions at which to apply attention.</span>
<span class="sd">        n_embed (int): number of embeddings, unique codes in the latent space.</span>
<span class="sd">        embed_dim (int): dimension of embedding from Encoder.</span>
<span class="sd">        dropout (float): dropout rate.</span>
<span class="sd">        double_z (bool): whether to double the latent space for.</span>
<span class="sd">        resamp_with_conv (bool): whether to use convolutions for upsampling.</span>
<span class="sd">        use_gumbel (bool): whether to use gumbel softmax for quantization.</span>
<span class="sd">        gumb_temp (float): temperature for gumbel softmax.</span>
<span class="sd">        act_name (str): activation function name to use.</span>
<span class="sd">        give_pre_end (bool): whether to give the pre-end layer for the decoder.</span>
<span class="sd">        kwargs: keyword arguments passed along to the super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
        <span class="n">out_ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">num_res_blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">z_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">ch_mult</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
        <span class="n">attn_resolutions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,),</span>
        <span class="n">n_embed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">embed_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">double_z</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resamp_with_conv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_gumbel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">gumb_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">kl_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span>
        <span class="n">act_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;swish&quot;</span><span class="p">,</span>
        <span class="n">give_pre_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_ch</span> <span class="o">=</span> <span class="n">out_ch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">in_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">=</span> <span class="n">num_res_blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_channels</span> <span class="o">=</span> <span class="n">z_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_mult</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ch_mult</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn_resolutions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attn_resolutions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_embed</span> <span class="o">=</span> <span class="n">n_embed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">double_z</span> <span class="o">=</span> <span class="n">double_z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resamp_with_conv</span> <span class="o">=</span> <span class="n">resamp_with_conv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gumbel</span> <span class="o">=</span> <span class="n">use_gumbel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gumb_temp</span> <span class="o">=</span> <span class="n">gumb_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span> <span class="o">=</span> <span class="n">kl_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act_name</span> <span class="o">=</span> <span class="n">act_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">give_pre_end</span> <span class="o">=</span> <span class="n">give_pre_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_mult</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="losses">Losses</h2>


<div class="doc doc-object doc-module">


<a id="modules.losses"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="modules.losses.combo_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">combo_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute combined l1 and l2 loss : l1 if l2 &lt; 0.5 else l2.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>predictions</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Predictions from the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>targets</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Targets for the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Reconstruction loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">combo_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute combined l1 and l2 loss : l1 if l2 &lt; 0.5 else l2.</span>
<span class="sd">    Args:</span>
<span class="sd">        predictions (jnp.ndarray): Predictions from the model.</span>
<span class="sd">        targets (jnp.ndarray): Targets for the model.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Reconstruction loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l2</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.losses.disc_loss_hinge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">disc_loss_hinge</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute discriminator loss for hinge GAN.
Real and fake logits influence the loss the same.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>real</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Real images, received from dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fake</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Fake images, produced by generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Discriminator loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">disc_loss_hinge</span><span class="p">(</span><span class="n">real</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fake</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute discriminator loss for hinge GAN.</span>
<span class="sd">    Real and fake logits influence the loss the same.</span>
<span class="sd">    Args:</span>
<span class="sd">        real: Real images, received from dataset.</span>
<span class="sd">        fake: Fake images, produced by generator.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Discriminator loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">real</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_fake</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">fake</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">real_loss</span> <span class="o">+</span> <span class="n">loss_fake</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.losses.disc_loss_vanilla" class="doc doc-heading">
<code class="highlight language-python"><span class="n">disc_loss_vanilla</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute discriminator loss for vanilla GAN.
Wrong fake logits impact more the loss than the bad real logits.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>real</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Real images, received from dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fake</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Fake images, produced by generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Discriminator loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">disc_loss_vanilla</span><span class="p">(</span><span class="n">real</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fake</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute discriminator loss for vanilla GAN.</span>
<span class="sd">    Wrong fake logits impact more the loss than the bad real logits.</span>
<span class="sd">    Args:</span>
<span class="sd">        real: Real images, received from dataset.</span>
<span class="sd">        fake: Fake images, produced by generator.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Discriminator loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">real</span><span class="p">))</span>
    <span class="n">generated_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">fake</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">real_loss</span> <span class="o">+</span> <span class="n">generated_loss</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.losses.l1_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l1_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute L1 loss.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>predictions</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Predictions from the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>targets</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Targets for the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Reconstruction loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">l1_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute L1 loss.</span>
<span class="sd">    Args:</span>
<span class="sd">        predictions (jnp.ndarray): Predictions from the model.</span>
<span class="sd">        targets (jnp.ndarray): Targets for the model.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Reconstruction loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.losses.l2_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l2_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute L2 loss.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>predictions</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Predictions from the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>targets</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Targets for the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Reconstruction loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">l2_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute L2 loss.</span>
<span class="sd">    Args:</span>
<span class="sd">        predictions (jnp.ndarray): Predictions from the model.</span>
<span class="sd">        targets (jnp.ndarray): Targets for the model.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Reconstruction loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.losses.mape_loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mape_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute mean absolute percentage error loss.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>predictions</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Predictions from the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>targets</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Targets for the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Reconstruction loss.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/losses.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mape_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute mean absolute percentage error loss.</span>
<span class="sd">    Args:</span>
<span class="sd">        predictions (jnp.ndarray): Predictions from the model.</span>
<span class="sd">        targets (jnp.ndarray): Targets for the model.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Reconstruction loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">targets</span> <span class="o">-</span> <span class="n">predictions</span><span class="p">)</span> <span class="o">/</span> <span class="n">targets</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="models">Models</h2>


<div class="doc doc-object doc-module">


<a id="modules.models"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.models.AttnBlock" class="doc doc-heading">
        <code>AttnBlock</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Attention block.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of input channels.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AttnBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attention block.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_channels (int): number of input channels.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): input tensor.</span>
<span class="sd">        Returns:</span>
<span class="sd">            output tensor with the same shape as the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h_</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">h_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
        <span class="c1"># get query, key, value</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>

        <span class="c1"># compute attention</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
        <span class="n">w_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bqc,bkc-&gt;bqk&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">w_</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">w_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">w_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># attend to values</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
        <span class="n">h_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bkc,bqk-&gt;bqc&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_</span><span class="p">)</span>
        <span class="n">h_</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">h_</span><span class="p">,</span> <span class="s2">&quot;B (H W) C -&gt; B H W C&quot;</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">h_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
        <span class="n">h_</span> <span class="o">+=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">h_</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.models.AttnBlock.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Forward pass of the block.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>input tensor.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>output tensor with the same shape as the input.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/models.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): input tensor.</span>
<span class="sd">    Returns:</span>
<span class="sd">        output tensor with the same shape as the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h_</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">h_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
    <span class="c1"># get query, key, value</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>

    <span class="c1"># compute attention</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
    <span class="n">w_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bqc,bkc-&gt;bqk&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">w_</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">w_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">w_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># attend to values</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;B H W C -&gt; B (H W) C&quot;</span><span class="p">)</span>
    <span class="n">h_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bkc,bqk-&gt;bqc&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_</span><span class="p">)</span>
    <span class="n">h_</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">h_</span><span class="p">,</span> <span class="s2">&quot;B (H W) C -&gt; B H W C&quot;</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">h_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">h_</span><span class="p">)</span>
    <span class="n">h_</span> <span class="o">+=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">h_</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.Decoder" class="doc doc-heading">
        <code>Decoder</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Decoder of VQ-GAN to map input batch of latent space to images.
Dimension Transformations originally:
32x32x256 --Conv2d--&gt; 32x32x512
--MidBlock--&gt; 32x32x512</p>

<details class="for-loop">
  <summary>for loop</summary>
  <p>--UpsamplingBlock--&gt; 64x64x256
--UpsamplingBlock--&gt; 128x128x128
--UpsamplingBlock--&gt; 256x256x64
--UpsamplingBlock--&gt; 256x256x32</p>
</details>      <p>--GroupNorm--&gt;
--nonlinear--&gt;
--Conv2d-&gt; 256x256x3</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decoder of VQ-GAN to map input batch of latent space to images.</span>
<span class="sd">    Dimension Transformations originally:</span>
<span class="sd">    32x32x256 --Conv2d--&gt; 32x32x512</span>
<span class="sd">    --MidBlock--&gt; 32x32x512</span>
<span class="sd">    for loop:</span>
<span class="sd">        --UpsamplingBlock--&gt; 64x64x256</span>
<span class="sd">        --UpsamplingBlock--&gt; 128x128x128</span>
<span class="sd">        --UpsamplingBlock--&gt; 256x256x64</span>
<span class="sd">        --UpsamplingBlock--&gt; 256x256x32</span>
<span class="sd">    --GroupNorm--&gt;</span>
<span class="sd">    --nonlinear--&gt;</span>
<span class="sd">    --Conv2d-&gt; 256x256x3</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        act_fn (str): activation function.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">gelu</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># time embedding</span>
        <span class="n">temb_ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># compute in_ch_mult and block_in at lowest res</span>
        <span class="n">block_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># z_channel to block_in</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="n">block_in</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># middle</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">MidBlock</span><span class="p">(</span>
            <span class="n">block_in</span><span class="p">,</span>
            <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
            <span class="n">temb_channels</span><span class="o">=</span><span class="n">temb_ch</span><span class="p">,</span>
            <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

        <span class="c1"># upsampling</span>
        <span class="c1"># compute curr_res at lowest res</span>
        <span class="n">curr_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolution</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">UpsamplingBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">curr_res</span><span class="p">,</span> <span class="n">block_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span>
            <span class="p">)</span>

            <span class="c1"># update resolution if not end</span>
            <span class="n">curr_res</span> <span class="o">=</span> <span class="n">curr_res</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">curr_res</span>

        <span class="c1"># end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">give_pre_end</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="c1"># CFN</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">out_ch</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.Downsample" class="doc doc-heading">
        <code>Downsample</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Downsample the input by a factor of 2.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of input channels.</p></td>
        </tr>
        <tr>
          <td><code>use_conv</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to use a identity convolution.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Downsample</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Downsample the input by a factor of 2.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_channels (int): Number of input channels.</span>
<span class="sd">        use_conv (bool): Whether to use a identity convolution.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">use_conv</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_conv</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># pad height and width dim</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">window_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.DownsamplingBlock" class="doc doc-heading">
        <code>DownsamplingBlock</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Downsampling block for Encoder.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>curr_res</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>current resolution.</p></td>
        </tr>
        <tr>
          <td><code>blck_idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>current block index.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DownsamplingBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Downsampling block for Encoder.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        curr_res (int): current resolution.</span>
<span class="sd">        blck_idx (int): current block index.</span>
<span class="sd">        act_fn (Callable): activation function.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">curr_res</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">block_idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">gelu</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get input and output numb of channels based on config and current block index.</span>
        <span class="n">in_ch_mult</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">)</span>
        <span class="n">block_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span> <span class="o">*</span> <span class="n">in_ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span><span class="p">]</span>
        <span class="n">block_out</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span><span class="p">]</span>

        <span class="c1"># temporary embedding channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temb_ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># build blocks</span>
        <span class="n">res_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attn_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_res_blocks</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">block_in</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
            <span class="n">res_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ResNetBlock</span><span class="p">(</span>
                    <span class="n">block_in</span><span class="p">,</span>
                    <span class="n">block_out</span><span class="p">,</span>
                    <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
                    <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_ch</span><span class="p">,</span>
                    <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># after channel downsample rest are identity blocks.</span>
            <span class="n">block_in</span> <span class="o">=</span> <span class="n">block_out</span>
            <span class="c1"># check if we need to add attention block based on configs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">attn_resolutions</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">block_in</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
                <span class="n">attn_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AttnBlock</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">res_blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attns</span> <span class="o">=</span> <span class="n">attn_blocks</span>

        <span class="c1"># downsample if not last block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">Downsample</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resamp_with_conv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): input tensor.</span>
<span class="sd">            temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">            deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">temb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DownsamplingBlock don&#39;t use temporal embedding&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res_block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.models.DownsamplingBlock.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Forward pass of the block.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>input tensor.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temb</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>temporal embedding. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>deterministic</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>deterministic flag. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/models.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): input tensor.</span>
<span class="sd">        temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">        deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">temb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DownsamplingBlock don&#39;t use temporal embedding&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res_block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">res_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.Encoder" class="doc doc-heading">
        <code>Encoder</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Encoder of VQ-GAN to map input batch of images to latent space.
Dimension Transformations originally:
256x256x3 --Conv2d--&gt; 256x256x32</p>

<details class="for-loop">
  <summary>for loop</summary>
  <p>--DownsamplingBlock--&gt; 128x128x64
--DownsamplingBlock--&gt; 64x64x128
--DownsamplingBlock--&gt; 32x32x256
--DownsamplingBlock--&gt; 32x32x512</p>
</details>      <p>--MidBlock--&gt; 32x32x512
--GroupNorm--&gt;
--nonlinear--&gt;
--Conv2d-&gt; 32x32x256</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encoder of VQ-GAN to map input batch of images to latent space.</span>
<span class="sd">    Dimension Transformations originally:</span>
<span class="sd">    256x256x3 --Conv2d--&gt; 256x256x32</span>
<span class="sd">    for loop:</span>
<span class="sd">        --DownsamplingBlock--&gt; 128x128x64</span>
<span class="sd">        --DownsamplingBlock--&gt; 64x64x128</span>
<span class="sd">        --DownsamplingBlock--&gt; 32x32x256</span>
<span class="sd">        --DownsamplingBlock--&gt; 32x32x512</span>

<span class="sd">    --MidBlock--&gt; 32x32x512</span>
<span class="sd">    --GroupNorm--&gt;</span>
<span class="sd">    --nonlinear--&gt;</span>
<span class="sd">    --Conv2d-&gt; 32x32x256</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        act_fn (str): activation function.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">gelu</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># time embedding</span>
        <span class="n">temb_ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># downsampling</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">curr_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">DownsamplingBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">curr_res</span><span class="p">,</span> <span class="n">block_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span>
            <span class="p">)</span>

            <span class="c1"># update resolution if not bottleneck</span>
            <span class="n">curr_res</span> <span class="o">=</span> <span class="n">curr_res</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">curr_res</span>
        <span class="c1"># middle</span>
        <span class="n">mid_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">MidBlock</span><span class="p">(</span>
            <span class="n">mid_channels</span><span class="p">,</span>
            <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
            <span class="n">temb_channels</span><span class="o">=</span><span class="n">temb_ch</span><span class="p">,</span>
            <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

        <span class="c1"># end CFN</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">z_channels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">double_z</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">z_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.MidBlock" class="doc doc-heading">
        <code>MidBlock</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Mid block for Encoder and Decoder.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of input channels.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>temb_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of channels for temporal embedding.</p></td>
        </tr>
        <tr>
          <td><code>dropout_prob</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>dropout probability.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MidBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mid block for Encoder and Decoder.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_channels (int): number of input channels.</span>
<span class="sd">        act_fn (str): activation function.</span>
<span class="sd">        temb_channels (int): number of channels for temporal embedding.</span>
<span class="sd">        dropout_prob (float): dropout probability.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">temb_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dropout_prob</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;BxWxHxC --ResNet--&gt; BxWxHxC --Attn--&gt; BxWxHxC --ResNet--&gt; BxWxHxC</span>

<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): input tensor.</span>
<span class="sd">            temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">            deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ResNetBlock</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
            <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_channels</span><span class="p">,</span>
            <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_prob</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">AttnBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ResNetBlock</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
            <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
            <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_channels</span><span class="p">,</span>
            <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_prob</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.models.MidBlock.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>BxWxHxC --ResNet--&gt; BxWxHxC --Attn--&gt; BxWxHxC --ResNet--&gt; BxWxHxC</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>input tensor.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temb</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>temporal embedding. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>deterministic</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>deterministic flag. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/models.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;BxWxHxC --ResNet--&gt; BxWxHxC --Attn--&gt; BxWxHxC --ResNet--&gt; BxWxHxC</span>

<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): input tensor.</span>
<span class="sd">        temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">        deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ResNetBlock</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
        <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_channels</span><span class="p">,</span>
        <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_prob</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">AttnBlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ResNetBlock</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
        <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_channels</span><span class="p">,</span>
        <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_prob</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.ResNetBlock" class="doc doc-heading">
        <code>ResNetBlock</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>ResNet block with optional bottleneck.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of input channels.</p></td>
        </tr>
        <tr>
          <td><code>out_channels</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>number of output channels.
If None, the output channels will be the same as the input channels.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>use_conv_shortcut</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to use a convolutional shortcut.</p></td>
        </tr>
        <tr>
          <td><code>temb_channels</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>number of channels in the temporal embedding.</p></td>
        </tr>
        <tr>
          <td><code>dropout_prob</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>dropout probability.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResNetBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ResNet block with optional bottleneck.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_channels (int): number of input channels.</span>
<span class="sd">        out_channels (Optional[int]): number of output channels.</span>
<span class="sd">            If None, the output channels will be the same as the input channels.</span>
<span class="sd">        act_fn (Callable): activation function.</span>
<span class="sd">        use_conv_shortcut (bool): whether to use a convolutional shortcut.</span>
<span class="sd">        temb_channels (jnp.ndarray): number of channels in the temporal embedding.</span>
<span class="sd">        dropout_prob (float): dropout probability.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">out_channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">gelu</span>
    <span class="n">use_conv_shortcut</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">temb_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">dropout_prob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># out_channels not specified, we will residual block will be identity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span>
        <span class="p">)</span>

        <span class="c1">#  First block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Project temporary embedding to be add to hidden states</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temb_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temb_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Second block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block2_pre</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block2_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_prob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bloc2_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if output x channels do not match residual channels, we need to project residual</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_conv_shortcut</span><span class="p">:</span>
                <span class="c1"># Reduce by conv(3,3) only channels with learned spatial features</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conv_shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reduce by conv(1,1) only channels</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): input tensor.</span>
<span class="sd">            temb (Optional[int], optional): temporal embedding. Defaults to None.</span>
<span class="sd">            deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">        Returns:</span>
<span class="sd">            output tensor with the out_channels dimension as the last dimension (C).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># transform temporal embedding to match hidden states [BxT] -&gt; [BxC] -&gt; [Bx1x1xC]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temb_proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">(</span><span class="n">temb</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block2_pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block2_drop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bloc2_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_conv_shortcut</span><span class="p">:</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_shortcut</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.models.ResNetBlock.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Forward pass of the block.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>input tensor.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temb</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>temporal embedding. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>deterministic</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>deterministic flag. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>output tensor with the out_channels dimension as the last dimension (C).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/models.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): input tensor.</span>
<span class="sd">        temb (Optional[int], optional): temporal embedding. Defaults to None.</span>
<span class="sd">        deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">    Returns:</span>
<span class="sd">        output tensor with the out_channels dimension as the last dimension (C).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">temb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># transform temporal embedding to match hidden states [BxT] -&gt; [BxC] -&gt; [Bx1x1xC]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">temb_proj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">(</span><span class="n">temb</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block2_pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block2_drop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bloc2_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels_</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_conv_shortcut</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_shortcut</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.Upsample" class="doc doc-heading">
        <code>Upsample</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Upsample the input by a factor of 2.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>in_channels</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of input channels.</p></td>
        </tr>
        <tr>
          <td><code>use_conv</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to use a identity convolution.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Upsample</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Upsample the input by a factor of 2.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        in_channels (int): Number of input channels.</span>
<span class="sd">        use_conv (bool): Whether to use a identity convolution.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">in_channels</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">use_conv</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">batch</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">channels</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_conv</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.models.UpsamplingBlock" class="doc doc-heading">
        <code>UpsamplingBlock</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Upsampling block for Decoder.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>curr_res</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>current resolution.</p></td>
        </tr>
        <tr>
          <td><code>blck_idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>current block index.</p></td>
        </tr>
        <tr>
          <td><code>act_fn</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td><p>activation function.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UpsamplingBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Upsampling block for Decoder.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        curr_res (int): current resolution.</span>
<span class="sd">        blck_idx (int): current block index.</span>
<span class="sd">        act_fn (Callable): activation function.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">curr_res</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">block_idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">gelu</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get input numb of channels based on config and current block index.</span>
        <span class="c1"># Looking in reverse on self.config.ch_mult variable.</span>
        <span class="n">block_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">block_in</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_in</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get output numb of channels based on config and current block index</span>
        <span class="n">block_out</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span><span class="p">]</span>
        <span class="c1"># temporary embedding channels UpsamplingBlock don&#39;t use temporal embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temb_ch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># build blocks</span>
        <span class="n">res_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attn_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">block_in</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
            <span class="n">res_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ResNetBlock</span><span class="p">(</span>
                    <span class="n">block_in</span><span class="p">,</span>
                    <span class="n">block_out</span><span class="p">,</span>
                    <span class="n">act_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">act_fn</span><span class="p">,</span>
                    <span class="n">temb_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temb_ch</span><span class="p">,</span>
                    <span class="n">dropout_prob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># after channel resize rest are identity blocks.</span>
            <span class="n">block_in</span> <span class="o">=</span> <span class="n">block_out</span>
            <span class="c1"># check if we need to add attention block based on configs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">attn_resolutions</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">block_in</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;block_in must be divisible by 32 for GroupNorm&quot;</span>
                <span class="n">attn_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AttnBlock</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">res_blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attns</span> <span class="o">=</span> <span class="n">attn_blocks</span>

        <span class="c1"># upsample if not first block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="n">Upsample</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resamp_with_conv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): input tensor.</span>
<span class="sd">            temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">            deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">temb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UpsamplingBlock don&#39;t use temporal embedding&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res_block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.models.UpsamplingBlock.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Forward pass of the block.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>input tensor.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temb</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>temporal embedding. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>deterministic</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>deterministic flag. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/models.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Forward pass of the block.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): input tensor.</span>
<span class="sd">        temb (Optional[jnp.ndarray], optional): temporal embedding. Defaults to None.</span>
<span class="sd">        deterministic (bool, optional): deterministic flag. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">temb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UpsamplingBlock don&#39;t use temporal embedding&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res_block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">res_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temb</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attns</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="training">Training</h2>


<div class="doc doc-object doc-module">


<a id="modules.training"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.training.GenerateCallback" class="doc doc-heading">
        <code>GenerateCallback</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Callback that generates and logs images during training.</p>


        <details class="quote">
          <summary>Source code in <code>modules/training.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">GenerateCallback</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Callback that generates and logs images during training.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_imgs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the callback.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_imgs (Any): Images to reconstruct during training</span>
<span class="sd">            every_n_epochs (int, optional):</span>
<span class="sd">                Only save those images every N epochs (otherwise tensorboard gets quite large).</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_imgs</span> <span class="o">=</span> <span class="n">input_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">every_n_epochs</span> <span class="o">=</span> <span class="n">every_n_epochs</span>

    <span class="k">def</span> <span class="nf">log_generations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">FlaxPreTrainedModel</span><span class="p">,</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">logger_tb</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">SummaryWriter</span><span class="p">,</span>
        <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">every_n_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging images to tensorboard at epoch </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">gumble_apply_rng</span><span class="p">,</span> <span class="n">dropout_apply_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">reconst_imgs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_imgs</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">model_params</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">dropout_rng</span><span class="o">=</span><span class="n">dropout_apply_rng</span><span class="p">,</span>
                <span class="n">gumble_rng</span><span class="o">=</span><span class="n">gumble_apply_rng</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reconst_imgs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">reconst_imgs</span><span class="p">)</span>

            <span class="c1"># Plot and add to tensorboard</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_imgs</span><span class="p">,</span> <span class="n">reconst_imgs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">input_imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">post_processing</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">img_to_log</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_img_grid</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">logger_tb</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="s2">&quot;Reconstructions&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">img_to_log</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.training.GenerateCallback.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">input_imgs</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">every_n_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the callback.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_imgs</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>Images to reconstruct during training</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>every_n_epochs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Only save those images every N epochs (otherwise tensorboard gets quite large).
Defaults to 1.</p></td>
          <td>
                <code>1</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_imgs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the callback.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_imgs (Any): Images to reconstruct during training</span>
<span class="sd">        every_n_epochs (int, optional):</span>
<span class="sd">            Only save those images every N epochs (otherwise tensorboard gets quite large).</span>
<span class="sd">            Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_imgs</span> <span class="o">=</span> <span class="n">input_imgs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">every_n_epochs</span> <span class="o">=</span> <span class="n">every_n_epochs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.training.TrainStateDisc" class="doc doc-heading">
        <code>TrainStateDisc</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.training.train_state">train_state</span>.<span title="flax.training.train_state.TrainState">TrainState</span></code></p>

  
      <p>Train state for discriminator.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>apply_fn</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td><p>The function that applies the model.</p></td>
        </tr>
        <tr>
          <td><code>step</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The current step.</p></td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span></code>
          </td>
          <td><p>The model parameters.</p></td>
        </tr>
        <tr>
          <td><code>batch_stats</code></td>
          <td>
                <code><span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span></code>
          </td>
          <td><p>The batch statistics. Defaults to None.</p></td>
        </tr>
        <tr>
          <td><code>tx</code></td>
          <td>
                <code>optax.<span title="optax.GradientTransformation">GradientTransformation</span></code>
          </td>
          <td><p>The optimizer. Defaults to None.</p></td>
        </tr>
        <tr>
          <td><code>opt_state</code></td>
          <td>
                <code>optax.<span title="optax.OptState">OptState</span></code>
          </td>
          <td><p>The optimizer state. Defaults to None.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/training.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TrainStateDisc</span><span class="p">(</span><span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train state for discriminator.</span>
<span class="sd">    Attributes:</span>
<span class="sd">        apply_fn (Callable): The function that applies the model.</span>
<span class="sd">        step (int): The current step.</span>
<span class="sd">        params (FrozenDict): The model parameters.</span>
<span class="sd">        batch_stats (FrozenDict): The batch statistics. Defaults to None.</span>
<span class="sd">        tx (optax.GradientTransformation): The optimizer. Defaults to None.</span>
<span class="sd">        opt_state (optax.OptState): The optimizer state. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">batch_stats</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.training.TrainerModule" class="doc doc-heading">
        <code>TrainerModule</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Helper functions for training.</p>


        <details class="quote">
          <summary>Source code in <code>modules/training.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TrainerModule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper functions for training.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_config</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">TrainConfig</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="n">FlaxPreTrainedModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Module for summarizing all common training functionalities.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_config (TrainConfig): Configuration for training</span>
<span class="sd">                with all hyperparameters and train module parameters.</span>
<span class="sd">            model_class (FlaxPreTrainedModel): Model class to be trained.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span> <span class="o">=</span> <span class="n">module_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span> <span class="o">=</span> <span class="n">module_config</span><span class="o">.</span><span class="n">monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenerateCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">)</span>
        <span class="c1"># Set model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_hparams</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set training parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">(</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">opt_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Prepare logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">SummaryWriter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">create_file_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
        <span class="c1"># Create jitted training and eval functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_functions</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented in sub-classes.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">init_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize optimizer and scheduler.</span>
<span class="sd">        By default, we decrease the learning rate with cosine annealing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_train_state</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_train_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize training state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">optimizer</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train model for defined number of epochs.</span>
<span class="sd">        Args:</span>
<span class="sd">            train_loader (utils.DataLoader): Training data loader.</span>
<span class="sd">            val_loader (utils.DataLoader): Validation data loader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We first need to create optimizer and the scheduler for the given number of epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_optimizer</span><span class="p">()</span>
        <span class="c1"># Track best eval metric</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training 💃&quot;</span><span class="p">)</span>
        <span class="n">best_eval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">epoch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">epoch_idx</span><span class="p">)</span>
                <span class="n">train_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
                <span class="n">train_metrics_str</span> <span class="o">=</span> <span class="s2">&quot;Training metrics:&quot;</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_metrics</span><span class="p">:</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
                    <span class="n">train_metrics_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">,&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">train_metrics_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">epoch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">check_val_every_n_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">eval_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
                    <span class="n">eval_metrics_str</span> <span class="o">=</span> <span class="s2">&quot;Evaluation metrics:&quot;</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">eval_metrics</span><span class="p">:</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
                        <span class="n">eval_metrics_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">eval_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">eval_metrics_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">best_eval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_eval</span><span class="p">:</span>
                        <span class="n">best_eval</span> <span class="o">=</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">epoch_idx</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="o">=</span> <span class="n">GenerateCallback</span><span class="p">(</span>
                            <span class="n">batch</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span><span class="p">,</span>
                            <span class="n">every_n_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">log_img_every_n_epoch</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span><span class="o">.</span><span class="n">log_generations</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch_idx</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished training ✅ with best eval metric: </span><span class="si">%f</span><span class="s2"> 😎&quot;</span><span class="p">,</span> <span class="n">best_eval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Train model for one epoch, and log avg metrics.</span>
<span class="sd">        Args:</span>
<span class="sd">            data_loader (utils.DataLoader): Data loader to train on.</span>
<span class="sd">            epoch (int): Current epoch.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with all metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># ensure that model have actual parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
            <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
                <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">metrics</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train model on a single batch.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (TrainState): Current training state.</span>
<span class="sd">            batch (Any): Batch of data.</span>
<span class="sd">            rng (Union[Any, jnp.ndarray]): Random number generator.</span>
<span class="sd">            distributed (bool, optional): Whether to use distributed training. Defaults to False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Updated training states, rng and metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model on a single batch.</span>
<span class="sd">        Args:</span>
<span class="sd">            state (TrainState): Current training state.</span>
<span class="sd">            batch (Any): Batch of data.</span>
<span class="sd">            rng (Union[Any, jnp.ndarray]): Random number generator.</span>
<span class="sd">        Returns:</span>
<span class="sd">            New rng and metrics.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Test model on all images of a data loader and return avg metrics.</span>
<span class="sd">        Args:</span>
<span class="sd">            data_loader (utils.DataLoader): Data loader to evaluate on.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with all metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Evaluating&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span>
            <span class="p">)</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save current model.</span>
<span class="sd">        Args:</span>
<span class="sd">            step (int, optional): Current step. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model 📠 for step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">checkpoints</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
            <span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;rng&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">},</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">push_model_to_hub</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Saving weights and logs&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Push model to huggingface hub.</span>
<span class="sd">        Args:</span>
<span class="sd">            repo_id (str): Repository id to push to Hugging Face.</span>
<span class="sd">            commit_message (str, optional): Commit message. Defaults to &quot;Saving weights and logs&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pushing model to Hugging Face Hub 🚀&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span>
            <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
            <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading model 🧠&quot;</span><span class="p">)</span>
        <span class="n">load_dict</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="o">.</span><span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
            <span class="n">step</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span>
            <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tx</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">opt_state</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;opt_state&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;rng&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
        <span class="k">if</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model is already trained 🎉&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">checkpoint_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether a pretrained model exist.</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if model exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">module_config</span><span class="p">,</span> <span class="n">model_class</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Module for summarizing all common training functionalities.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>module_config</code></td>
          <td>
                <code>TrainConfig</code>
          </td>
          <td><p>Configuration for training
with all hyperparameters and train module parameters.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_class</code></td>
          <td>
                <code><span title="transformers.modeling_flax_utils.FlaxPreTrainedModel">FlaxPreTrainedModel</span></code>
          </td>
          <td><p>Model class to be trained.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_config</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">TrainConfig</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="n">FlaxPreTrainedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Module for summarizing all common training functionalities.</span>

<span class="sd">    Args:</span>
<span class="sd">        module_config (TrainConfig): Configuration for training</span>
<span class="sd">            with all hyperparameters and train module parameters.</span>
<span class="sd">        model_class (FlaxPreTrainedModel): Model class to be trained.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span> <span class="o">=</span> <span class="n">module_config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span> <span class="o">=</span> <span class="n">module_config</span><span class="o">.</span><span class="n">monitor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenerateCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">)</span>
    <span class="c1"># Set model name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_hparams</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">input_shape</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Set training parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">(</span>
        <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">opt_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Prepare logging</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">SummaryWriter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">create_file_writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
    <span class="c1"># Create jitted training and eval functions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_functions</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.checkpoint_exists" class="doc doc-heading">
<code class="highlight language-python"><span class="n">checkpoint_exists</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Check whether a pretrained model exist.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>bool</code>
          </td>
          <td><p>True if model exists, False otherwise.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">checkpoint_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check whether a pretrained model exist.</span>
<span class="sd">    Returns:</span>
<span class="sd">        True if model exists, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.create_functions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_functions</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>To be implemented in sub-classes.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To be implemented in sub-classes.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.create_train_state" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_train_state</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize training state.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_train_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize training state.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">optimizer</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.eval_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">eval_model</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Test model on all images of a data loader and return avg metrics.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data_loader</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils" href="#modules.utils">utils</a>.<a class="autorefs autorefs-internal" title="modules.utils.DataLoader" href="#modules.utils.DataLoader">DataLoader</a></code>
          </td>
          <td><p>Data loader to evaluate on.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, float]</code>
          </td>
          <td><p>Dictionary with all metrics.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Test model on all images of a data loader and return avg metrics.</span>
<span class="sd">    Args:</span>
<span class="sd">        data_loader (utils.DataLoader): Data loader to evaluate on.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Evaluating&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span>
        <span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">batch_size</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.eval_step" class="doc doc-heading">
<code class="highlight language-python"><span class="n">eval_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Evaluate model on a single batch.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>state</code></td>
          <td>
                <code>TrainState</code>
          </td>
          <td><p>Current training state.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>Batch of data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>Random number generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>], <span title="typing.Dict">Dict</span>[str, float]]</code>
          </td>
          <td><p>New rng and metrics.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate model on a single batch.</span>
<span class="sd">    Args:</span>
<span class="sd">        state (TrainState): Current training state.</span>
<span class="sd">        batch (Any): Batch of data.</span>
<span class="sd">        rng (Union[Any, jnp.ndarray]): Random number generator.</span>
<span class="sd">    Returns:</span>
<span class="sd">        New rng and metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.init_optimizer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init_optimizer</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize optimizer and scheduler.
By default, we decrease the learning rate with cosine annealing.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize optimizer and scheduler.</span>
<span class="sd">    By default, we decrease the learning rate with cosine annealing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_train_state</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.load_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_model</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load model.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load model.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading model 🧠&quot;</span><span class="p">)</span>
    <span class="n">load_dict</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="o">.</span><span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">(</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
        <span class="n">step</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span>
        <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tx</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
        <span class="n">opt_state</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;opt_state&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;rng&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model is already trained 🎉&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.push_model_to_hub" class="doc doc-heading">
<code class="highlight language-python"><span class="n">push_model_to_hub</span><span class="p">(</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">commit_message</span><span class="o">=</span><span class="s1">&#39;Saving weights and logs&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Push model to huggingface hub.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>repo_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Repository id to push to Hugging Face.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>commit_message</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Commit message. Defaults to "Saving weights and logs".</p></td>
          <td>
                <code>&#39;Saving weights and logs&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">push_model_to_hub</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Saving weights and logs&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Push model to huggingface hub.</span>
<span class="sd">    Args:</span>
<span class="sd">        repo_id (str): Repository id to push to Hugging Face.</span>
<span class="sd">        commit_message (str, optional): Commit message. Defaults to &quot;Saving weights and logs&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pushing model to Hugging Face Hub 🚀&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span>
        <span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span>
        <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.save_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save current model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>step</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Current step. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save current model.</span>
<span class="sd">    Args:</span>
<span class="sd">        step (int, optional): Current step. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model 📠 for step </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">checkpoints</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
        <span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;rng&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">},</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.train_epoch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_epoch</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Train model for one epoch, and log avg metrics.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data_loader</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils" href="#modules.utils">utils</a>.<a class="autorefs autorefs-internal" title="modules.utils.DataLoader" href="#modules.utils.DataLoader">DataLoader</a></code>
          </td>
          <td><p>Data loader to train on.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>epoch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Current epoch.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, float]</code>
          </td>
          <td><p>Dictionary with all metrics.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Train model for one epoch, and log avg metrics.</span>
<span class="sd">    Args:</span>
<span class="sd">        data_loader (utils.DataLoader): Data loader to train on.</span>
<span class="sd">        epoch (int): Current epoch.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># ensure that model have actual parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
        <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.train_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_model</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Train model for defined number of epochs.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train_loader</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils" href="#modules.utils">utils</a>.<a class="autorefs autorefs-internal" title="modules.utils.DataLoader" href="#modules.utils.DataLoader">DataLoader</a></code>
          </td>
          <td><p>Training data loader.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>val_loader</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils" href="#modules.utils">utils</a>.<a class="autorefs autorefs-internal" title="modules.utils.DataLoader" href="#modules.utils.DataLoader">DataLoader</a></code>
          </td>
          <td><p>Validation data loader.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train model for defined number of epochs.</span>
<span class="sd">    Args:</span>
<span class="sd">        train_loader (utils.DataLoader): Training data loader.</span>
<span class="sd">        val_loader (utils.DataLoader): Validation data loader.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We first need to create optimizer and the scheduler for the given number of epochs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_optimizer</span><span class="p">()</span>
    <span class="c1"># Track best eval metric</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training 💃&quot;</span><span class="p">)</span>
    <span class="n">best_eval</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">epoch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">epoch_idx</span><span class="p">)</span>
            <span class="n">train_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
            <span class="n">train_metrics_str</span> <span class="o">=</span> <span class="s2">&quot;Training metrics:&quot;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_metrics</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
                <span class="n">train_metrics_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">train_metrics_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">epoch_idx</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">check_val_every_n_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">eval_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
                <span class="n">eval_metrics_str</span> <span class="o">=</span> <span class="s2">&quot;Evaluation metrics:&quot;</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">eval_metrics</span><span class="p">:</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch_idx</span><span class="p">)</span>
                    <span class="n">eval_metrics_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">eval_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">,&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">eval_metrics_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_eval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_eval</span><span class="p">:</span>
                    <span class="n">best_eval</span> <span class="o">=</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">epoch_idx</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="o">=</span> <span class="n">GenerateCallback</span><span class="p">(</span>
                        <span class="n">batch</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span><span class="p">,</span>
                        <span class="n">every_n_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">log_img_every_n_epoch</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_callback_rng</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_callback</span><span class="o">.</span><span class="n">log_generations</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch_idx</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished training ✅ with best eval metric: </span><span class="si">%f</span><span class="s2"> 😎&quot;</span><span class="p">,</span> <span class="n">best_eval</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerModule.train_step" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">distributed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Train model on a single batch.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>state</code></td>
          <td>
                <code>TrainState</code>
          </td>
          <td><p>Current training state.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>Batch of data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>Random number generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>distributed</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to use distributed training. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>Updated training states, rng and metrics.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Train model on a single batch.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (TrainState): Current training state.</span>
<span class="sd">        batch (Any): Batch of data.</span>
<span class="sd">        rng (Union[Any, jnp.ndarray]): Random number generator.</span>
<span class="sd">        distributed (bool, optional): Whether to use distributed training. Defaults to False.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Updated training states, rng and metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.training.TrainerVQGan" class="doc doc-heading">
        <code>TrainerVQGan</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="modules.training.TrainerModule" href="#modules.training.TrainerModule">TrainerModule</a></code></p>

  
      <p>Helper functions for training VQGAN.</p>


        <details class="quote">
          <summary>Source code in <code>modules/training.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TrainerVQGan</span><span class="p">(</span><span class="n">TrainerModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper functions for training VQGAN.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_config</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">TrainConfig</span><span class="p">):</span>
        <span class="c1"># Initialize parent class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span> <span class="o">=</span> <span class="n">module_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">recon_loss</span> <span class="o">==</span> <span class="s2">&quot;l2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">l2_loss</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">recon_loss</span> <span class="o">==</span> <span class="s2">&quot;l1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">l1_loss</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">recon_loss</span> <span class="o">==</span> <span class="s2">&quot;combo&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">combo_loss</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">recon_loss</span> <span class="o">==</span> <span class="s2">&quot;mape&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">mape_loss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Reconstruction loss function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">recon_loss</span><span class="si">}</span><span class="s2"> not supported.</span>
<span class="s2">                Will be used default l1 loss instead.&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">l1_loss</span>
        <span class="c1"># Train state for discriminator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">:</span> <span class="n">FlaxPreTrainedModel</span> <span class="o">=</span> <span class="n">vqgan</span><span class="o">.</span><span class="n">VQGanDiscriminator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_hparams</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_loss</span> <span class="o">==</span> <span class="s2">&quot;vanilla&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">disc_loss_vanilla</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_loss</span> <span class="o">==</span> <span class="s2">&quot;hinge&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">disc_loss_hinge</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Discriminator loss function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_loss</span><span class="si">}</span><span class="s2"> not supported.</span>
<span class="s2">                Will be used default hinge loss instead.&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">disc_loss_hinge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span> <span class="o">=</span> <span class="n">TrainStateDisc</span><span class="p">(</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
            <span class="n">batch_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">],</span>
            <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">opt_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Log dir discriminator loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_disc/&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">temp_scheduler</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">module_config</span><span class="o">=</span><span class="n">module_config</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="n">vqgan</span><span class="o">.</span><span class="n">VQModel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">temperature_scheduling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Temperature scheduling.</span>
<span class="sd">        Args:</span>
<span class="sd">            epoch (int): Current epoch.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Temperature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_hparams</span><span class="o">.</span><span class="n">gumb_temp</span>

    <span class="k">def</span> <span class="nf">init_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize optimizer and scheduler also for discriminator.</span>
<span class="sd">        By default, we decrease the learning rate with cosine annealing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span>
        <span class="n">optimizer_disc</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer_disc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_train_stat_full</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">optimizer_disc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_train_stat_full</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">,</span>
        <span class="n">optimizer_disc</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize training state.</span>
<span class="sd">        Args:</span>
<span class="sd">            optimizer (optax.GradientTransformation): Optimizer for generator.</span>
<span class="sd">            optimizer_disc (optax.GradientTransformation): Optimizer for discriminator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">optimizer</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span> <span class="o">=</span> <span class="n">TrainStateDisc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">batch_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
            <span class="n">tx</span><span class="o">=</span><span class="n">optimizer_disc</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save current model.</span>
<span class="sd">        Args:</span>
<span class="sd">            step (int, optional): Current step. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="n">checkpoints</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
            <span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load model.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="o">.</span><span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span> <span class="o">=</span> <span class="n">TrainStateDisc</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
            <span class="n">batch_stats</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">],</span>
            <span class="n">step</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span>
            <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">tx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">tx</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer_disc</span><span class="p">,</span>
            <span class="n">opt_state</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;opt_state&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span>

    <span class="k">def</span> <span class="nf">checkpoint_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether a pretrained model exist.</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if model and discriminator exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">main_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">disc_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">main_model</span> <span class="ow">and</span> <span class="n">disc_model</span>

    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Train model for one epoch, and log avg metrics.</span>
<span class="sd">        Args:</span>
<span class="sd">            data_loader (utils.DataLoader): Data loader to train on.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with all metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">metrics_disc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_scheduling</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
            <span class="n">train_outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
                <span class="n">optimizer_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">disc_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_start</span> <span class="o">&gt;</span> <span class="n">epoch</span><span class="p">,</span>
                <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="n">train_outs</span>
            <span class="c1"># Update metrics</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_start</span> <span class="o">&gt;</span> <span class="n">epoch</span><span class="p">:</span>
                <span class="n">batch_metrics_disc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
                <span class="n">train_outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span>
                    <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                    <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
                    <span class="n">optimizer_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">disc_use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics_disc</span> <span class="o">=</span> <span class="n">train_outs</span>
                <span class="c1"># Update metrics discriminator</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch_metrics_disc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">metrics_disc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>

            <span class="c1"># ensure that model have actual parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span>

        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_temp</span>
        <span class="n">count_disc</span> <span class="o">=</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
        <span class="n">metrics_disc_resized</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count_disc</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics_disc</span>
        <span class="p">}</span>
        <span class="c1"># merge metrics</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_disc_resized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">create_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create training and eval functions.&quot;&quot;&quot;</span>
        <span class="n">recon_loss_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span>
        <span class="n">disc_loss_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss_fn</span>

        <span class="k">def</span> <span class="nf">calculate_loss_autoencoder</span><span class="p">(</span>
            <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">disc_variables</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="sd">&quot;&quot;&quot;Function to calculate the loss autoencoder for a batch of images.&quot;&quot;&quot;</span>
            <span class="n">new_rng</span><span class="p">,</span> <span class="n">gumble_apply_rng</span><span class="p">,</span> <span class="n">dropout_apply_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">dropout_rng</span><span class="o">=</span><span class="n">dropout_apply_rng</span><span class="p">,</span>
                <span class="n">gumble_rng</span><span class="o">=</span><span class="n">gumble_apply_rng</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">x_recon</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">codebook_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="c1"># for now we will use l1 loss than it will be combined with perceptual loss</span>
            <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">recon_loss_fn</span><span class="p">(</span><span class="n">x_recon</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">nll_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rec_loss</span><span class="p">)</span>

            <span class="c1"># Generator loss (autoencode)</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span>
                <span class="n">x_recon</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">disc_variables</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">batch_stats</span><span class="o">=</span><span class="n">disc_variables</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logits_fake</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Original loss is</span>
            <span class="c1"># g_loss = -jnp.mean(logits_fake)</span>
            <span class="c1"># But we think that based on disc for generator should work we will use minimax loss</span>
            <span class="c1"># This loss is none negative and tries to maximize the probability of the fake_logits.</span>
            <span class="n">g_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">logits_fake</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">disc_factor</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">disc_use</span><span class="p">:</span>
                <span class="n">disc_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span>
            <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">disc_use</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">nll_loss</span>
                <span class="o">+</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="n">g_loss</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">codebook_weight</span> <span class="o">*</span> <span class="n">codebook_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
                <span class="s2">&quot;quant_loss&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">codebook_loss</span><span class="p">),</span>
                <span class="s2">&quot;nll_loss&quot;</span><span class="p">:</span> <span class="n">nll_loss</span><span class="p">,</span>
                <span class="s2">&quot;rec_loss&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rec_loss</span><span class="p">),</span>
                <span class="s2">&quot;g_loss&quot;</span><span class="p">:</span> <span class="n">g_loss</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">calculate_loss_disc</span><span class="p">(</span>
            <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">batch_stats</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
            <span class="n">model_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="sd">&quot;&quot;&quot;Function to calculate the loss discriminator for a batch of images.&quot;&quot;&quot;</span>
            <span class="n">new_rng</span><span class="p">,</span> <span class="n">gumble_apply_rng</span><span class="p">,</span> <span class="n">dropout_apply_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
                <span class="n">dropout_rng</span><span class="o">=</span><span class="n">dropout_apply_rng</span><span class="p">,</span>
                <span class="n">gumble_rng</span><span class="o">=</span><span class="n">gumble_apply_rng</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">x_recon</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">codebook_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">outs</span>

            <span class="c1"># Discriminator loss</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">batch_stats</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">)</span>
            <span class="n">logits_real</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span><span class="n">x_recon</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">batch_stats</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">)</span>
            <span class="n">logits_fake</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">disc_use</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="n">disc_loss_fn</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;disc_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
                <span class="s2">&quot;logits_real&quot;</span><span class="p">:</span> <span class="n">logits_real</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;logits_fake&quot;</span><span class="p">:</span> <span class="n">logits_fake</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">train_step_autoencoder</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
            <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Train step for autoencoder.&quot;&quot;&quot;</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">calculate_loss_autoencoder</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">disc_use</span><span class="o">=</span><span class="n">disc_use</span><span class="p">,</span>
                <span class="n">disc_variables</span><span class="o">=</span><span class="n">disc_state</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
                <span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="c1"># if distributed training, average grads</span>
            <span class="k">if</span> <span class="n">distributed</span><span class="p">:</span>
                <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">pmean</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
            <span class="c1"># Update parameters</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

        <span class="k">def</span> <span class="nf">train_step_disc</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
            <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Train step for discriminator.&quot;&quot;&quot;</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">calculate_loss_disc</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">disc_use</span><span class="o">=</span><span class="n">disc_use</span><span class="p">,</span>
                <span class="n">batch_stats</span><span class="o">=</span><span class="n">disc_state</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
                <span class="n">model_params</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
                <span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)(</span><span class="n">disc_state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="c1"># if distributed training, average grads</span>
            <span class="k">if</span> <span class="n">distributed</span><span class="p">:</span>
                <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">pmean</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
            <span class="c1"># Update parameters, batch statistics</span>
            <span class="n">disc_state</span> <span class="o">=</span> <span class="n">disc_state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span>
                <span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">new_model_state</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

        <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
            <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">optimizer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Train model on a single batch.&quot;&quot;&quot;</span>
            <span class="c1"># calculate loss</span>
            <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outs</span> <span class="o">=</span> <span class="n">train_step_autoencoder</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">disc_use</span><span class="p">,</span> <span class="n">distributed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outs</span> <span class="o">=</span> <span class="n">train_step_disc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">disc_use</span><span class="p">,</span> <span class="n">distributed</span><span class="p">)</span>
            <span class="c1"># outs = jax.lax.cond(</span>
            <span class="c1">#  optimizer_idx == 0,</span>
            <span class="c1">#    lambda _: train_step_autoencoder(state,</span>
            <span class="c1">#                                     disc_state,</span>
            <span class="c1">#                                     batch,</span>
            <span class="c1">#                                     rng,</span>
            <span class="c1">#                                     disc_use,</span>
            <span class="c1">#                                     distributed),</span>
            <span class="c1">#    lambda _: train_step_disc(state,</span>
            <span class="c1">#                              disc_state,</span>
            <span class="c1">#                              batch,</span>
            <span class="c1">#                              rng,</span>
            <span class="c1">#                              disc_use,</span>
            <span class="c1">#                              distributed),</span>
            <span class="c1">#    None)</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

        <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
            <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
            <span class="sd">&quot;&quot;&quot;Evaluate model on a single batch.&quot;&quot;&quot;</span>
            <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">calculate_loss_autoencoder</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">disc_use</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">disc_variables</span><span class="o">=</span><span class="n">disc_state</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

        <span class="c1"># pmap or jit for efficiency</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">train_step</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">static_broadcasted_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">eval_step</span><span class="p">,</span> <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">eval_step</span><span class="p">,</span> <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.checkpoint_exists" class="doc doc-heading">
<code class="highlight language-python"><span class="n">checkpoint_exists</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Check whether a pretrained model exist.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>bool</code>
          </td>
          <td><p>True if model and discriminator exists, False otherwise.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">checkpoint_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check whether a pretrained model exist.</span>
<span class="sd">    Returns:</span>
<span class="sd">        True if model and discriminator exists, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">disc_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">main_model</span> <span class="ow">and</span> <span class="n">disc_model</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.create_functions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_functions</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Create training and eval functions.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create training and eval functions.&quot;&quot;&quot;</span>
    <span class="n">recon_loss_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_loss_fn</span>
    <span class="n">disc_loss_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss_fn</span>

    <span class="k">def</span> <span class="nf">calculate_loss_autoencoder</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">disc_variables</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Function to calculate the loss autoencoder for a batch of images.&quot;&quot;&quot;</span>
        <span class="n">new_rng</span><span class="p">,</span> <span class="n">gumble_apply_rng</span><span class="p">,</span> <span class="n">dropout_apply_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">dropout_rng</span><span class="o">=</span><span class="n">dropout_apply_rng</span><span class="p">,</span>
            <span class="n">gumble_rng</span><span class="o">=</span><span class="n">gumble_apply_rng</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">x_recon</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">codebook_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="c1"># for now we will use l1 loss than it will be combined with perceptual loss</span>
        <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">recon_loss_fn</span><span class="p">(</span><span class="n">x_recon</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
        <span class="n">nll_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rec_loss</span><span class="p">)</span>

        <span class="c1"># Generator loss (autoencode)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span>
            <span class="n">x_recon</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">disc_variables</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">batch_stats</span><span class="o">=</span><span class="n">disc_variables</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logits_fake</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Original loss is</span>
        <span class="c1"># g_loss = -jnp.mean(logits_fake)</span>
        <span class="c1"># But we think that based on disc for generator should work we will use minimax loss</span>
        <span class="c1"># This loss is none negative and tries to maximize the probability of the fake_logits.</span>
        <span class="n">g_loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">logits_fake</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">disc_factor</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">disc_use</span><span class="p">:</span>
            <span class="n">disc_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span>
        <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">disc_use</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">nll_loss</span>
            <span class="o">+</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="n">g_loss</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">codebook_weight</span> <span class="o">*</span> <span class="n">codebook_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
            <span class="s2">&quot;quant_loss&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">codebook_loss</span><span class="p">),</span>
            <span class="s2">&quot;nll_loss&quot;</span><span class="p">:</span> <span class="n">nll_loss</span><span class="p">,</span>
            <span class="s2">&quot;rec_loss&quot;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rec_loss</span><span class="p">),</span>
            <span class="s2">&quot;g_loss&quot;</span><span class="p">:</span> <span class="n">g_loss</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_loss_disc</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">batch_stats</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">model_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Function to calculate the loss discriminator for a batch of images.&quot;&quot;&quot;</span>
        <span class="n">new_rng</span><span class="p">,</span> <span class="n">gumble_apply_rng</span><span class="p">,</span> <span class="n">dropout_apply_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">model_params</span><span class="p">,</span>
            <span class="n">dropout_rng</span><span class="o">=</span><span class="n">dropout_apply_rng</span><span class="p">,</span>
            <span class="n">gumble_rng</span><span class="o">=</span><span class="n">gumble_apply_rng</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">x_recon</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">codebook_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">outs</span>

        <span class="c1"># Discriminator loss</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">batch_stats</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">)</span>
        <span class="n">logits_real</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="p">(</span><span class="n">x_recon</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">batch_stats</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">)</span>
        <span class="n">logits_fake</span><span class="p">,</span> <span class="n">new_model_state</span> <span class="o">=</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">disc_use</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_weight</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="n">disc_loss_fn</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;disc_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
            <span class="s2">&quot;logits_real&quot;</span><span class="p">:</span> <span class="n">logits_real</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;logits_fake&quot;</span><span class="p">:</span> <span class="n">logits_fake</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_step_autoencoder</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Train step for autoencoder.&quot;&quot;&quot;</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">calculate_loss_autoencoder</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">disc_use</span><span class="o">=</span><span class="n">disc_use</span><span class="p">,</span>
            <span class="n">disc_variables</span><span class="o">=</span><span class="n">disc_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
            <span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># if distributed training, average grads</span>
        <span class="k">if</span> <span class="n">distributed</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">pmean</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
        <span class="c1"># Update parameters</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">train_step_disc</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Train step for discriminator.&quot;&quot;&quot;</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">calculate_loss_disc</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">disc_use</span><span class="o">=</span><span class="n">disc_use</span><span class="p">,</span>
            <span class="n">batch_stats</span><span class="o">=</span><span class="n">disc_state</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
            <span class="n">model_params</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">new_model_state</span><span class="p">)),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span>
            <span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)(</span><span class="n">disc_state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># if distributed training, average grads</span>
        <span class="k">if</span> <span class="n">distributed</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">pmean</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
        <span class="c1"># Update parameters, batch statistics</span>
        <span class="n">disc_state</span> <span class="o">=</span> <span class="n">disc_state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span>
            <span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">,</span> <span class="n">batch_stats</span><span class="o">=</span><span class="n">new_model_state</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">optimizer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">disc_use</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span> <span class="n">TrainStateDisc</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Train model on a single batch.&quot;&quot;&quot;</span>
        <span class="c1"># calculate loss</span>
        <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">train_step_autoencoder</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">disc_use</span><span class="p">,</span> <span class="n">distributed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">train_step_disc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">disc_use</span><span class="p">,</span> <span class="n">distributed</span><span class="p">)</span>
        <span class="c1"># outs = jax.lax.cond(</span>
        <span class="c1">#  optimizer_idx == 0,</span>
        <span class="c1">#    lambda _: train_step_autoencoder(state,</span>
        <span class="c1">#                                     disc_state,</span>
        <span class="c1">#                                     batch,</span>
        <span class="c1">#                                     rng,</span>
        <span class="c1">#                                     disc_use,</span>
        <span class="c1">#                                     distributed),</span>
        <span class="c1">#    lambda _: train_step_disc(state,</span>
        <span class="c1">#                              disc_state,</span>
        <span class="c1">#                              batch,</span>
        <span class="c1">#                              rng,</span>
        <span class="c1">#                              disc_use,</span>
        <span class="c1">#                              distributed),</span>
        <span class="c1">#    None)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">disc_state</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">disc_state</span><span class="p">:</span> <span class="n">TrainStateDisc</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model on a single batch.&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">calculate_loss_autoencoder</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">disc_use</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">disc_variables</span><span class="o">=</span><span class="n">disc_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_rng</span><span class="p">,</span> <span class="n">metrics</span>

    <span class="c1"># pmap or jit for efficiency</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">train_step</span><span class="p">,</span> <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">static_broadcasted_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">eval_step</span><span class="p">,</span> <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">eval_step</span><span class="p">,</span> <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.create_train_stat_full" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_train_stat_full</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">optimizer_disc</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize training state.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>optimizer</code></td>
          <td>
                <code>optax.<span title="optax.GradientTransformation">GradientTransformation</span></code>
          </td>
          <td><p>Optimizer for generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>optimizer_disc</code></td>
          <td>
                <code>optax.<span title="optax.GradientTransformation">GradientTransformation</span></code>
          </td>
          <td><p>Optimizer for discriminator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_train_stat_full</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">,</span>
    <span class="n">optimizer_disc</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize training state.</span>
<span class="sd">    Args:</span>
<span class="sd">        optimizer (optax.GradientTransformation): Optimizer for generator.</span>
<span class="sd">        optimizer_disc (optax.GradientTransformation): Optimizer for discriminator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">train_state</span><span class="o">.</span><span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">optimizer</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span> <span class="o">=</span> <span class="n">TrainStateDisc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
        <span class="n">batch_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">,</span>
        <span class="n">tx</span><span class="o">=</span><span class="n">optimizer_disc</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.init_optimizer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init_optimizer</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize optimizer and scheduler also for discriminator.
By default, we decrease the learning rate with cosine annealing.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize optimizer and scheduler also for discriminator.</span>
<span class="sd">    By default, we decrease the learning rate with cosine annealing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer</span>
    <span class="n">optimizer_disc</span><span class="p">:</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer_disc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_train_stat_full</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">optimizer_disc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.load_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_model</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load model.</p>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load model.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="o">.</span><span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span> <span class="o">=</span> <span class="n">TrainStateDisc</span><span class="p">(</span>
        <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
        <span class="n">batch_stats</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">],</span>
        <span class="n">step</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span>
        <span class="n">tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">tx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">tx</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">optimizer_disc</span><span class="p">,</span>
        <span class="n">opt_state</span><span class="o">=</span><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;opt_state&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.save_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_model</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Save current model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>step</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Current step. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save current model.</span>
<span class="sd">    Args:</span>
<span class="sd">        step (int, optional): Current step. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">num_epochs</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
    <span class="n">checkpoints</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
        <span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir_disc</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.temperature_scheduling" class="doc doc-heading">
<code class="highlight language-python"><span class="n">temperature_scheduling</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Temperature scheduling.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>epoch</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Current epoch.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>Temperature.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">temperature_scheduling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Temperature scheduling.</span>
<span class="sd">    Args:</span>
<span class="sd">        epoch (int): Current epoch.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Temperature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">model_hparams</span><span class="o">.</span><span class="n">gumb_temp</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.training.TrainerVQGan.train_epoch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_epoch</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Train model for one epoch, and log avg metrics.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data_loader</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils" href="#modules.utils">utils</a>.<a class="autorefs autorefs-internal" title="modules.utils.DataLoader" href="#modules.utils.DataLoader">DataLoader</a></code>
          </td>
          <td><p>Data loader to train on.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, float]</code>
          </td>
          <td><p>Dictionary with all metrics.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/training.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Train model for one epoch, and log avg metrics.</span>
<span class="sd">    Args:</span>
<span class="sd">        data_loader (utils.DataLoader): Data loader to train on.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">metrics_disc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">new_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_scheduling</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">batch_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
        <span class="n">train_outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
            <span class="n">optimizer_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">disc_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_start</span> <span class="o">&gt;</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics</span> <span class="o">=</span> <span class="n">train_outs</span>
        <span class="c1"># Update metrics</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">disc_start</span> <span class="o">&gt;</span> <span class="n">epoch</span><span class="p">:</span>
            <span class="n">batch_metrics_disc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
            <span class="n">train_outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="n">disc_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span>
                <span class="n">optimizer_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">disc_use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">distributed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_config</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_rng</span><span class="p">,</span> <span class="n">batch_metrics_disc</span> <span class="o">=</span> <span class="n">train_outs</span>
            <span class="c1"># Update metrics discriminator</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch_metrics_disc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metrics_disc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>

        <span class="c1"># ensure that model have actual parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_disc</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_disc</span><span class="o">.</span><span class="n">batch_stats</span>

    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_temp</span>
    <span class="n">count_disc</span> <span class="o">=</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
    <span class="n">metrics_disc_resized</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">metrics_disc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count_disc</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics_disc</span>
    <span class="p">}</span>
    <span class="c1"># merge metrics</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_disc_resized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="utils">Utils</h2>


<div class="doc doc-object doc-module">


<a id="modules.utils"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.utils.BaseDataset" class="doc doc-heading">
        <code>BaseDataset</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Load the dataset. Abstract method.</p>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseDataset</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load the dataset. Abstract method.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DataConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the dataset.</span>
<span class="sd">        Args:</span>
<span class="sd">            train: If the dataset is for training.</span>
<span class="sd">            config: The config for the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_transforms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_transforms</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Transforms must be provided for training.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train_params</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">test_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Dataset is empty.&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">        Args:</span>
<span class="sd">            train: If the dataset is for training.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the length of the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Preprocess the image.</span>
<span class="sd">        Args:</span>
<span class="sd">            image: The image to preprocess.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The preprocessed image.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">aug_fn</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">}</span>
            <span class="n">aug_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="n">aug_data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">aug_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">aug_img</span> <span class="o">-</span> <span class="n">IMAGENET_STANDARD_MEAN</span><span class="p">)</span> <span class="o">/</span> <span class="n">IMAGENET_STANDARD_STD</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">aug_img</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">aug_img</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_transforms</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">numpy_function</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">aug_fn</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="p">[</span><span class="n">image</span><span class="p">],</span> <span class="n">Tout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">IMAGENET_STANDARD_MEAN</span><span class="p">)</span> <span class="o">/</span> <span class="n">IMAGENET_STANDARD_STD</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the dataset.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shuffle</span> <span class="k">else</span> <span class="n">dataset</span>
        <span class="k">return</span> <span class="n">dataset</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.utils.BaseDataset.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Set the dataset.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the dataset is for training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.DataConfig" href="#modules.config.DataConfig">DataConfig</a></code>
          </td>
          <td><p>The config for the dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DataConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Set the dataset.</span>
<span class="sd">    Args:</span>
<span class="sd">        train: If the dataset is for training.</span>
<span class="sd">        config: The config for the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset_root</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_transforms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_transforms</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Transforms must be provided for training.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train_params</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">test_params</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Dataset is empty.&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.BaseDataset.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the length of the dataset.</p>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the length of the dataset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.BaseDataset.get_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dataset</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the dataset.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shuffle</span> <span class="k">else</span> <span class="n">dataset</span>
    <span class="k">return</span> <span class="n">dataset</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.BaseDataset.load_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the dataset.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the dataset is for training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">    Args:</span>
<span class="sd">        train: If the dataset is for training.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.utils.DataLoader" class="doc doc-heading">
        <code>DataLoader</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Dataloader similar as in pytorch.</p>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Dataloader similar as in pytorch.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">,</span> <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a data loader.</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset (BaseDataset): The dataset to load.</span>
<span class="sd">            distributed (bool): If the data is distributed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">distributed</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the length of the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the dataset in dataloader style.&quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">:</span>
            <span class="n">per_core_bs</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">per_core_bs</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()),</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ds = map(lambda x: x._numpy(), ds.prefetch(tf.data.AUTOTUNE))</span>
        <span class="c1"># data = flax.jax_utils.prefetch_to_device(ds, 3) if self.dist else ds</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">flax</span><span class="o">.</span><span class="n">jax_utils</span><span class="o">.</span><span class="n">prefetch_to_device</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="k">else</span> <span class="n">ds</span>
        <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.utils.DataLoader.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the dataset in dataloader style.</p>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the dataset in dataloader style.&quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">:</span>
        <span class="n">per_core_bs</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">per_core_bs</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()),</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ds = map(lambda x: x._numpy(), ds.prefetch(tf.data.AUTOTUNE))</span>
    <span class="c1"># data = flax.jax_utils.prefetch_to_device(ds, 3) if self.dist else ds</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">))</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">flax</span><span class="o">.</span><span class="n">jax_utils</span><span class="o">.</span><span class="n">prefetch_to_device</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="k">else</span> <span class="n">ds</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.DataLoader.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">distributed</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Create a data loader.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dataset</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.utils.BaseDataset" href="#modules.utils.BaseDataset">BaseDataset</a></code>
          </td>
          <td><p>The dataset to load.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>distributed</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the data is distributed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">,</span> <span class="n">distributed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a data loader.</span>
<span class="sd">    Args:</span>
<span class="sd">        dataset (BaseDataset): The dataset to load.</span>
<span class="sd">        distributed (bool): If the data is distributed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span> <span class="o">=</span> <span class="n">dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">distributed</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.DataLoader.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the length of the dataset.</p>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the length of the dataset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_placeholder</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.utils.DummyDataset" class="doc doc-heading">
        <code>DummyDataset</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="modules.utils.BaseDataset" href="#modules.utils.BaseDataset">BaseDataset</a></code></p>

  
      <p>Create dummy dataset.</p>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DummyDataset</span><span class="p">(</span><span class="n">BaseDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create dummy dataset.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">        Args:</span>
<span class="sd">            train: If the dataset is for training.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mf">255.0</span>
        <span class="p">)</span>  <span class="c1"># 0-255</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.utils.DummyDataset.load_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the dataset.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the dataset is for training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">    Args:</span>
<span class="sd">        train: If the dataset is for training.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">*</span> <span class="mf">255.0</span>
    <span class="p">)</span>  <span class="c1"># 0-255</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.utils.TensorflowDataset" class="doc doc-heading">
        <code>TensorflowDataset</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="modules.utils.BaseDataset" href="#modules.utils.BaseDataset">BaseDataset</a></code></p>

  
      <p>Tensorflow dataset.</p>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TensorflowDataset</span><span class="p">(</span><span class="n">BaseDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tensorflow dataset.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">        Args:</span>
<span class="sd">            train: If the dataset is for training.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The dataset.&quot;&quot;&quot;</span>

        <span class="c1"># if you get error &#39;Too many open files&#39; one can resolve it doing what this issue proposed</span>
        <span class="c1"># https://github.com/tensorflow/datasets/issues/1441#issuecomment-581660890</span>
        <span class="c1"># Below is the code to resolve it</span>
        <span class="c1"># import resource</span>
        <span class="c1"># low, high = resource.getrlimit(resource.RLIMIT_NOFILE)</span>
        <span class="c1"># resource.setrlimit(resource.RLIMIT_NOFILE, (high, high))</span>
        <span class="n">split</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="s2">&quot;validation&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span>
            <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">do_not_convert</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span>
                <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">do_not_convert</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.utils.TensorflowDataset.load_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load the dataset.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the dataset is for training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load the dataset.</span>
<span class="sd">    Args:</span>
<span class="sd">        train: If the dataset is for training.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The dataset.&quot;&quot;&quot;</span>

    <span class="c1"># if you get error &#39;Too many open files&#39; one can resolve it doing what this issue proposed</span>
    <span class="c1"># https://github.com/tensorflow/datasets/issues/1441#issuecomment-581660890</span>
    <span class="c1"># Below is the code to resolve it</span>
    <span class="c1"># import resource</span>
    <span class="c1"># low, high = resource.getrlimit(resource.RLIMIT_NOFILE)</span>
    <span class="c1"># resource.setrlimit(resource.RLIMIT_NOFILE, (high, high))</span>
    <span class="n">split</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="s2">&quot;validation&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">do_not_convert</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span>
            <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">do_not_convert</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.utils.VQGanFeatureExtractor" class="doc doc-heading">
        <code>VQGanFeatureExtractor</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="modules.utils.VQGanImageProcessor" href="#modules.utils.VQGanImageProcessor">VQGanImageProcessor</a></code></p>

  
      <p>Extract features for VQGan from images.
Extends VQGanImageProcessor only with call function to run preprocessing.</p>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQGanFeatureExtractor</span><span class="p">(</span><span class="n">VQGanImageProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract features for VQGan from images.</span>
<span class="sd">    Extends VQGanImageProcessor only with call function to run preprocessing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchFeature</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.utils.VQGanImageProcessor" class="doc doc-heading">
        <code>VQGanImageProcessor</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Constructs a VQGan image processor.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>do_resize</code></td>
          <td>
                <code>`bool`, *optional*, defaults to `True`</code>
          </td>
          <td><p>Whether to resize the image's (height, width) dimensions to the specified
<code>(size["height"], size["width"])</code>. Can be overridden by the <code>do_resize</code> parameter in
the <code>preprocess</code> method.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>size</code></td>
          <td>
                <code>`dict`, *optional*, defaults to `{&#34;height&#34;</code>
          </td>
          <td><p>256, "width": 256}<code>):
Size of the output image after resizing. Can be overridden by the</code>size<code>parameter in
the</code>preprocess` method.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>resample</code></td>
          <td>
                <code>`Image.Resampling`, *optional*, defaults to `Image.Resampling.BILINEAR`</code>
          </td>
          <td><p>Resampling filter to use if resizing the image. Can be overridden by the <code>resample</code>
parameter in the <code>preprocess</code> method.</p></td>
          <td>
                <code>Image.Resampling.BILINEAR</code>
          </td>
        </tr>
        <tr>
          <td><code>do_rescale</code></td>
          <td>
                <code>`bool`, *optional*, defaults to `True`</code>
          </td>
          <td><p>Whether to rescale the image by the specified scale <code>rescale_factor</code>. Can be overridden
by the <code>do_rescale</code> parameter in the <code>preprocess</code> method.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>rescale_factor</code></td>
          <td>
                <code>`int` or `float`, *optional*, defaults to `1/255`</code>
          </td>
          <td><p>Scale factor to use if rescaling the image. Can be overridden by the <code>rescale_factor</code>
parameter in the <code>preprocess</code> method.</p></td>
          <td>
                <code>1 / 255</code>
          </td>
        </tr>
        <tr>
          <td><code>do_normalize</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to normalize the image. Can be overridden by the <code>do_normalize</code> parameter in
the <code>preprocess</code> method.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>image_mean</code></td>
          <td>
                <code>`float` or `List[float]`, *optional*, defaults to `IMAGENET_STANDARD_MEAN`</code>
          </td>
          <td><p>Mean to use if normalizing the image. This is a float or list of floats the length of
the number of channels in the image. Can be overridden by the <code>image_mean</code> parameter
in the <code>preprocess</code> method.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>image_std</code></td>
          <td>
                <code>`float` or `List[float]`, *optional*, defaults to `IMAGENET_STANDARD_STD`</code>
          </td>
          <td><p>Standard deviation to use if normalizing the image. This is a float or list of floats
the length of the number of channels in the image. Can be overridden by the <code>image_std</code>
parameter in the <code>preprocess</code> method.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>`jax.numpy.dtype`, *optional*, defaults to `jax.numpy.float32`</code>
          </td>
          <td></td>
          <td>
                <code>jnp.float32</code>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQGanImageProcessor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a VQGan image processor.</span>
<span class="sd">    Args:</span>
<span class="sd">        do_resize (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            Whether to resize the image&#39;s (height, width) dimensions to the specified</span>
<span class="sd">            `(size[&quot;height&quot;], size[&quot;width&quot;])`. Can be overridden by the `do_resize` parameter in</span>
<span class="sd">            the `preprocess` method.</span>
<span class="sd">        size (`dict`, *optional*, defaults to `{&quot;height&quot;: 256, &quot;width&quot;: 256}`):</span>
<span class="sd">            Size of the output image after resizing. Can be overridden by the `size` parameter in</span>
<span class="sd">            the `preprocess` method.</span>
<span class="sd">        resample (`Image.Resampling`, *optional*, defaults to `Image.Resampling.BILINEAR`):</span>
<span class="sd">            Resampling filter to use if resizing the image. Can be overridden by the `resample`</span>
<span class="sd">            parameter in the `preprocess` method.</span>
<span class="sd">        do_rescale (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            Whether to rescale the image by the specified scale `rescale_factor`. Can be overridden</span>
<span class="sd">            by the `do_rescale` parameter in the `preprocess` method.</span>
<span class="sd">        rescale_factor (`int` or `float`, *optional*, defaults to `1/255`):</span>
<span class="sd">            Scale factor to use if rescaling the image. Can be overridden by the `rescale_factor`</span>
<span class="sd">            parameter in the `preprocess` method.</span>
<span class="sd">        do_normalize:</span>
<span class="sd">            Whether to normalize the image. Can be overridden by the `do_normalize` parameter in</span>
<span class="sd">            the `preprocess` method.</span>
<span class="sd">        image_mean (`float` or `List[float]`, *optional*, defaults to `IMAGENET_STANDARD_MEAN`):</span>
<span class="sd">            Mean to use if normalizing the image. This is a float or list of floats the length of</span>
<span class="sd">            the number of channels in the image. Can be overridden by the `image_mean` parameter</span>
<span class="sd">            in the `preprocess` method.</span>
<span class="sd">        image_std (`float` or `List[float]`, *optional*, defaults to `IMAGENET_STANDARD_STD`):</span>
<span class="sd">            Standard deviation to use if normalizing the image. This is a float or list of floats</span>
<span class="sd">            the length of the number of channels in the image. Can be overridden by the `image_std`</span>
<span class="sd">            parameter in the `preprocess` method.</span>
<span class="sd">        dtype (`jax.numpy.dtype`, *optional*, defaults to `jax.numpy.float32`):</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">do_resize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resample</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
        <span class="n">do_rescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">rescale_factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span>
        <span class="n">do_normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">image_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">image_std</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_resize</span> <span class="o">=</span> <span class="n">do_resize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_rescale</span> <span class="o">=</span> <span class="n">do_rescale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_normalize</span> <span class="o">=</span> <span class="n">do_normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale_factor</span> <span class="o">=</span> <span class="n">rescale_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_mean</span> <span class="o">=</span> <span class="n">image_mean</span> <span class="k">if</span> <span class="n">image_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">IMAGENET_STANDARD_MEAN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_std</span> <span class="o">=</span> <span class="n">image_std</span> <span class="k">if</span> <span class="n">image_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">IMAGENET_STANDARD_STD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">resample</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resize an image to `(size[&quot;height&quot;], size[&quot;width&quot;])`.</span>
<span class="sd">        Args:</span>
<span class="sd">            image (`np.ndarray`):</span>
<span class="sd">                Image to resize.</span>
<span class="sd">            size (`Dict[str, int]`):</span>
<span class="sd">                Dictionary in the format `{&quot;height&quot;: int, &quot;width&quot;: int}` specifying the size</span>
<span class="sd">                of the output image.</span>
<span class="sd">            resample:</span>
<span class="sd">                `Image.Resampling` filter to use when resizing the image e.g.</span>
<span class="sd">                `Image.Resampling.BILINEAR`.</span>
<span class="sd">            data_format (`str`, *optional*):</span>
<span class="sd">                The channel dimension format for the output image. If unset, the channel</span>
<span class="sd">                dimension format of the input image is used. Can be one of:</span>
<span class="sd">                - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">                - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The resized image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;height&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">size</span> <span class="ow">or</span> <span class="s2">&quot;width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The `size` dictionary must contain the keys `height` and `width`. Got&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
            <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="n">pil_image_resized</span> <span class="o">=</span> <span class="n">pil_image</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]),</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pil_image_resized</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">image_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">image_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">revert_format</span> <span class="k">else</span> <span class="n">image_np</span>
        <span class="k">return</span> <span class="n">image_np</span>

    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rescale an image by a scale factor. image = image * scale.</span>
<span class="sd">        Args:</span>
<span class="sd">            image (`np.ndarray`):</span>
<span class="sd">                Image to resize.</span>
<span class="sd">            scale (`float`):</span>
<span class="sd">                The scaling factor to rescale pixel values by.</span>
<span class="sd">            data_format (`str`, *optional*):</span>
<span class="sd">                The channel dimension format for the output image. If unset, the channel dimension</span>
<span class="sd">                format of the input image is used. Can be one of:</span>
<span class="sd">                - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">                - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The resized image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">image</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">std</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize an image. image = (image - image_mean) / image_std.</span>
<span class="sd">        Args:</span>
<span class="sd">            image (`np.ndarray`):</span>
<span class="sd">                Image to normalize.</span>
<span class="sd">            mean (`float` or `List[float]`):</span>
<span class="sd">                Image mean to use for normalization.</span>
<span class="sd">            std (`float` or `List[float]`):</span>
<span class="sd">                Image standard deviation to use for normalization.</span>
<span class="sd">            data_format (`str`, *optional*):</span>
<span class="sd">                The channel dimension format for the output image. If unset, the channel dimension</span>
<span class="sd">                format of the input image is used. Can be one of:</span>
<span class="sd">                - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">                - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The normalized image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
            <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">image_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="n">image_normalized</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_normalized</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">revert_format</span> <span class="k">else</span> <span class="n">image_normalized</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">image_normalized</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">images</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
        <span class="n">do_resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_rescale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rescale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_normalize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">image_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">image_std</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;channels_last&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchFeature</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess an image or batch of images.</span>
<span class="sd">        Args:</span>
<span class="sd">            images (`Image.Image`, `np.ndarray`, `List[Image.Image]`, `List[np.ndarray]`):</span>
<span class="sd">                Image to preprocess.</span>
<span class="sd">            do_resize (`bool`, *optional*, defaults to `self.do_resize`):</span>
<span class="sd">                Whether to resize the image.</span>
<span class="sd">            size (`Dict[str, int]`, *optional*, defaults to `self.size`):</span>
<span class="sd">                Dictionary in the format `{&quot;height&quot;: h, &quot;width&quot;: w}` specifying the size of the</span>
<span class="sd">                output image after resizing.</span>
<span class="sd">            resample (`Image.Resampling` filter, *optional*, defaults to `self.resample`):</span>
<span class="sd">                `Image.Resampling` filter to use if resizing the image e.g.</span>
<span class="sd">                `Image.Resampling.BILINEAR`. Only has an effect if `do_resize` is set to `True`.</span>
<span class="sd">            do_rescale (`bool`, *optional*, defaults to `self.do_rescale`):</span>
<span class="sd">                Whether to rescale the image values between [0 - 1].</span>
<span class="sd">            rescale_factor (`float`, *optional*, defaults to `self.rescale_factor`):</span>
<span class="sd">                Rescale factor to rescale the image by if `do_rescale` is set to `True`.</span>
<span class="sd">            do_normalize (`bool`, *optional*, defaults to `self.do_normalize`):</span>
<span class="sd">                Whether to normalize the image.</span>
<span class="sd">            image_mean (`float` or `List[float]`, *optional*, defaults to `self.image_mean`):</span>
<span class="sd">                Image mean to use if `do_normalize` is set to `True`.</span>
<span class="sd">            image_std (`float` or `List[float]`, *optional*, defaults to `self.image_std`):</span>
<span class="sd">                Image standard deviation to use if `do_normalize` is set to `True`.</span>
<span class="sd">            data_format (`str`, *optional*, defaults to `channels_las`):):</span>
<span class="sd">                The channel dimension format for the output image. Can be one of:</span>
<span class="sd">                - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">                - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">                - Unset: Use the channel dimension format of the input image.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The preprocessed image(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">data_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;channels_first&quot;</span><span class="p">,</span> <span class="s2">&quot;channels_last&quot;</span><span class="p">]</span>
        <span class="n">do_resize</span> <span class="o">=</span> <span class="n">do_resize</span> <span class="k">if</span> <span class="n">do_resize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_resize</span>
        <span class="n">do_rescale</span> <span class="o">=</span> <span class="n">do_rescale</span> <span class="k">if</span> <span class="n">do_rescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rescale</span>
        <span class="n">do_normalize</span> <span class="o">=</span> <span class="n">do_normalize</span> <span class="k">if</span> <span class="n">do_normalize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_normalize</span>
        <span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span> <span class="k">if</span> <span class="n">resample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span>
        <span class="n">rescale_factor</span> <span class="o">=</span> <span class="n">rescale_factor</span> <span class="k">if</span> <span class="n">rescale_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_factor</span>
        <span class="n">image_mean</span> <span class="o">=</span> <span class="n">image_mean</span> <span class="k">if</span> <span class="n">image_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mean</span>
        <span class="n">image_std</span> <span class="o">=</span> <span class="n">image_std</span> <span class="k">if</span> <span class="n">image_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_std</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># Batch of images and jnp.ndarray</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">)]</span>

        <span class="c1"># if needed to rescale the image</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">&quot;Image values must be in [0 - 255] range.&quot;</span>

        <span class="k">if</span> <span class="n">do_resize</span> <span class="ow">and</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Size must be specified if do_resize is True.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_rescale</span> <span class="ow">and</span> <span class="n">rescale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Rescale factor must be specified if do_rescale is True.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_resize</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">do_rescale</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">rescale_factor</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">do_normalize</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">image_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">image_std</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">:</span> <span class="n">images</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">BatchFeature</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">tensor_type</span><span class="o">=</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.utils.VQGanImageProcessor.normalize" class="doc doc-heading">
<code class="highlight language-python"><span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Normalize an image. image = (image - image_mean) / image_std.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>`np.ndarray`</code>
          </td>
          <td><p>Image to normalize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mean</code></td>
          <td>
                <code>`float` or `List[float]`</code>
          </td>
          <td><p>Image mean to use for normalization.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>std</code></td>
          <td>
                <code>`float` or `List[float]`</code>
          </td>
          <td><p>Image standard deviation to use for normalization.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>data_format</code></td>
          <td>
                <code>`str`, *optional*</code>
          </td>
          <td><p>The channel dimension format for the output image. If unset, the channel dimension
format of the input image is used. Can be one of:
- <code>"channels_first"</code>: image in (num_channels, height, width) format.
- <code>"channels_last"</code>: image in (height, width, num_channels) format.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The normalized image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">mean</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">std</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize an image. image = (image - image_mean) / image_std.</span>
<span class="sd">    Args:</span>
<span class="sd">        image (`np.ndarray`):</span>
<span class="sd">            Image to normalize.</span>
<span class="sd">        mean (`float` or `List[float]`):</span>
<span class="sd">            Image mean to use for normalization.</span>
<span class="sd">        std (`float` or `List[float]`):</span>
<span class="sd">            Image standard deviation to use for normalization.</span>
<span class="sd">        data_format (`str`, *optional*):</span>
<span class="sd">            The channel dimension format for the output image. If unset, the channel dimension</span>
<span class="sd">            format of the input image is used. Can be one of:</span>
<span class="sd">            - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">            - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The normalized image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
        <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">image_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
    <span class="n">image_normalized</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_normalized</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">revert_format</span> <span class="k">else</span> <span class="n">image_normalized</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">image_normalized</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.VQGanImageProcessor.preprocess" class="doc doc-heading">
<code class="highlight language-python"><span class="n">preprocess</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">do_resize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_rescale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s1">&#39;channels_last&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Preprocess an image or batch of images.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>images</code></td>
          <td>
                <code>`Image.Image`, `np.ndarray`, `List[Image.Image]`, `List[np.ndarray]`</code>
          </td>
          <td><p>Image to preprocess.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>do_resize</code></td>
          <td>
                <code>`bool`, *optional*, defaults to `self.do_resize`</code>
          </td>
          <td><p>Whether to resize the image.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>size</code></td>
          <td>
                <code>`Dict[str, int]`, *optional*, defaults to `self.size`</code>
          </td>
          <td><p>Dictionary in the format <code>{"height": h, "width": w}</code> specifying the size of the
output image after resizing.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>resample</code></td>
          <td>
                <code>`Image.Resampling` filter, *optional*, defaults to `self.resample`</code>
          </td>
          <td><p><code>Image.Resampling</code> filter to use if resizing the image e.g.
<code>Image.Resampling.BILINEAR</code>. Only has an effect if <code>do_resize</code> is set to <code>True</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>do_rescale</code></td>
          <td>
                <code>`bool`, *optional*, defaults to `self.do_rescale`</code>
          </td>
          <td><p>Whether to rescale the image values between [0 - 1].</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>rescale_factor</code></td>
          <td>
                <code>`float`, *optional*, defaults to `self.rescale_factor`</code>
          </td>
          <td><p>Rescale factor to rescale the image by if <code>do_rescale</code> is set to <code>True</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>do_normalize</code></td>
          <td>
                <code>`bool`, *optional*, defaults to `self.do_normalize`</code>
          </td>
          <td><p>Whether to normalize the image.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>image_mean</code></td>
          <td>
                <code>`float` or `List[float]`, *optional*, defaults to `self.image_mean`</code>
          </td>
          <td><p>Image mean to use if <code>do_normalize</code> is set to <code>True</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>image_std</code></td>
          <td>
                <code>`float` or `List[float]`, *optional*, defaults to `self.image_std`</code>
          </td>
          <td><p>Image standard deviation to use if <code>do_normalize</code> is set to <code>True</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>data_format</code></td>
          <td>
                <code>`str`, *optional*, defaults to `channels_las`</code>
          </td>
          <td><p>):
The channel dimension format for the output image. Can be one of:
- <code>"channels_first"</code>: image in (num_channels, height, width) format.
- <code>"channels_last"</code>: image in (height, width, num_channels) format.
- Unset: Use the channel dimension format of the input image.</p></td>
          <td>
                <code>&#39;channels_last&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="transformers.BatchFeature">BatchFeature</span></code>
          </td>
          <td><p>The preprocessed image(s).</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">images</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">do_resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">do_rescale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rescale_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">do_normalize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">image_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">image_std</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">data_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;channels_last&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchFeature</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess an image or batch of images.</span>
<span class="sd">    Args:</span>
<span class="sd">        images (`Image.Image`, `np.ndarray`, `List[Image.Image]`, `List[np.ndarray]`):</span>
<span class="sd">            Image to preprocess.</span>
<span class="sd">        do_resize (`bool`, *optional*, defaults to `self.do_resize`):</span>
<span class="sd">            Whether to resize the image.</span>
<span class="sd">        size (`Dict[str, int]`, *optional*, defaults to `self.size`):</span>
<span class="sd">            Dictionary in the format `{&quot;height&quot;: h, &quot;width&quot;: w}` specifying the size of the</span>
<span class="sd">            output image after resizing.</span>
<span class="sd">        resample (`Image.Resampling` filter, *optional*, defaults to `self.resample`):</span>
<span class="sd">            `Image.Resampling` filter to use if resizing the image e.g.</span>
<span class="sd">            `Image.Resampling.BILINEAR`. Only has an effect if `do_resize` is set to `True`.</span>
<span class="sd">        do_rescale (`bool`, *optional*, defaults to `self.do_rescale`):</span>
<span class="sd">            Whether to rescale the image values between [0 - 1].</span>
<span class="sd">        rescale_factor (`float`, *optional*, defaults to `self.rescale_factor`):</span>
<span class="sd">            Rescale factor to rescale the image by if `do_rescale` is set to `True`.</span>
<span class="sd">        do_normalize (`bool`, *optional*, defaults to `self.do_normalize`):</span>
<span class="sd">            Whether to normalize the image.</span>
<span class="sd">        image_mean (`float` or `List[float]`, *optional*, defaults to `self.image_mean`):</span>
<span class="sd">            Image mean to use if `do_normalize` is set to `True`.</span>
<span class="sd">        image_std (`float` or `List[float]`, *optional*, defaults to `self.image_std`):</span>
<span class="sd">            Image standard deviation to use if `do_normalize` is set to `True`.</span>
<span class="sd">        data_format (`str`, *optional*, defaults to `channels_las`):):</span>
<span class="sd">            The channel dimension format for the output image. Can be one of:</span>
<span class="sd">            - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">            - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">            - Unset: Use the channel dimension format of the input image.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The preprocessed image(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">data_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;channels_first&quot;</span><span class="p">,</span> <span class="s2">&quot;channels_last&quot;</span><span class="p">]</span>
    <span class="n">do_resize</span> <span class="o">=</span> <span class="n">do_resize</span> <span class="k">if</span> <span class="n">do_resize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_resize</span>
    <span class="n">do_rescale</span> <span class="o">=</span> <span class="n">do_rescale</span> <span class="k">if</span> <span class="n">do_rescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rescale</span>
    <span class="n">do_normalize</span> <span class="o">=</span> <span class="n">do_normalize</span> <span class="k">if</span> <span class="n">do_normalize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_normalize</span>
    <span class="n">resample</span> <span class="o">=</span> <span class="n">resample</span> <span class="k">if</span> <span class="n">resample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span>
    <span class="n">rescale_factor</span> <span class="o">=</span> <span class="n">rescale_factor</span> <span class="k">if</span> <span class="n">rescale_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_factor</span>
    <span class="n">image_mean</span> <span class="o">=</span> <span class="n">image_mean</span> <span class="k">if</span> <span class="n">image_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_mean</span>
    <span class="n">image_std</span> <span class="o">=</span> <span class="n">image_std</span> <span class="k">if</span> <span class="n">image_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_std</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Batch of images and jnp.ndarray</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">)]</span>

    <span class="c1"># if needed to rescale the image</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">&quot;Image values must be in [0 - 255] range.&quot;</span>

    <span class="k">if</span> <span class="n">do_resize</span> <span class="ow">and</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Size must be specified if do_resize is True.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_rescale</span> <span class="ow">and</span> <span class="n">rescale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Rescale factor must be specified if do_rescale is True.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_resize</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_rescale</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">rescale_factor</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_normalize</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">image_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">image_std</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pixel_values&quot;</span><span class="p">:</span> <span class="n">images</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">BatchFeature</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">tensor_type</span><span class="o">=</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.VQGanImageProcessor.rescale" class="doc doc-heading">
<code class="highlight language-python"><span class="n">rescale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Rescale an image by a scale factor. image = image * scale.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>`np.ndarray`</code>
          </td>
          <td><p>Image to resize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scale</code></td>
          <td>
                <code>`float`</code>
          </td>
          <td><p>The scaling factor to rescale pixel values by.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>data_format</code></td>
          <td>
                <code>`str`, *optional*</code>
          </td>
          <td><p>The channel dimension format for the output image. If unset, the channel dimension
format of the input image is used. Can be one of:
- <code>"channels_first"</code>: image in (num_channels, height, width) format.
- <code>"channels_last"</code>: image in (height, width, num_channels) format.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The resized image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rescale an image by a scale factor. image = image * scale.</span>
<span class="sd">    Args:</span>
<span class="sd">        image (`np.ndarray`):</span>
<span class="sd">            Image to resize.</span>
<span class="sd">        scale (`float`):</span>
<span class="sd">            The scaling factor to rescale pixel values by.</span>
<span class="sd">        data_format (`str`, *optional*):</span>
<span class="sd">            The channel dimension format for the output image. If unset, the channel dimension</span>
<span class="sd">            format of the input image is used. Can be one of:</span>
<span class="sd">            - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">            - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The resized image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">image</span> <span class="o">*</span> <span class="n">scale</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.utils.VQGanImageProcessor.resize" class="doc doc-heading">
<code class="highlight language-python"><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Resize an image to <code>(size["height"], size["width"])</code>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>`np.ndarray`</code>
          </td>
          <td><p>Image to resize.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>size</code></td>
          <td>
                <code>`Dict[str, int]`</code>
          </td>
          <td><p>Dictionary in the format <code>{"height": int, "width": int}</code> specifying the size
of the output image.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resample</code></td>
          <td>
                <code><span title="PIL.Image">Image</span>.<span title="PIL.Image.Resampling">Resampling</span></code>
          </td>
          <td><p><code>Image.Resampling</code> filter to use when resizing the image e.g.
<code>Image.Resampling.BILINEAR</code>.</p></td>
          <td>
                <code>Image.Resampling.BILINEAR</code>
          </td>
        </tr>
        <tr>
          <td><code>data_format</code></td>
          <td>
                <code>`str`, *optional*</code>
          </td>
          <td><p>The channel dimension format for the output image. If unset, the channel
dimension format of the input image is used. Can be one of:
- <code>"channels_first"</code>: image in (num_channels, height, width) format.
- <code>"channels_last"</code>: image in (height, width, num_channels) format.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The resized image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">resample</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">,</span>
    <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resize an image to `(size[&quot;height&quot;], size[&quot;width&quot;])`.</span>
<span class="sd">    Args:</span>
<span class="sd">        image (`np.ndarray`):</span>
<span class="sd">            Image to resize.</span>
<span class="sd">        size (`Dict[str, int]`):</span>
<span class="sd">            Dictionary in the format `{&quot;height&quot;: int, &quot;width&quot;: int}` specifying the size</span>
<span class="sd">            of the output image.</span>
<span class="sd">        resample:</span>
<span class="sd">            `Image.Resampling` filter to use when resizing the image e.g.</span>
<span class="sd">            `Image.Resampling.BILINEAR`.</span>
<span class="sd">        data_format (`str`, *optional*):</span>
<span class="sd">            The channel dimension format for the output image. If unset, the channel</span>
<span class="sd">            dimension format of the input image is used. Can be one of:</span>
<span class="sd">            - `&quot;channels_first&quot;`: image in (num_channels, height, width) format.</span>
<span class="sd">            - `&quot;channels_last&quot;`: image in (height, width, num_channels) format.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The resized image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;height&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">size</span> <span class="ow">or</span> <span class="s2">&quot;width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The `size` dictionary must contain the keys `height` and `width`. Got&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s2">&quot;channels_first&quot;</span><span class="p">:</span>
        <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">revert_format</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
    <span class="n">pil_image_resized</span> <span class="o">=</span> <span class="n">pil_image</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]),</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
    <span class="n">image_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pil_image_resized</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">image_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">image_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">revert_format</span> <span class="k">else</span> <span class="n">image_np</span>
    <span class="k">return</span> <span class="n">image_np</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="modules.utils.make_img_grid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_img_grid</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Make image grid from images.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>images</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>image list to make grid.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nrows</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of rows. Defaults to 4.</p></td>
          <td>
                <code>4</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>image grid object.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_img_grid</span><span class="p">(</span><span class="n">images</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nrows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make image grid from images.</span>
<span class="sd">    Args:</span>
<span class="sd">        images (np.ndarray): image list to make grid.</span>
<span class="sd">        nrows (int, optional): number of rows. Defaults to 4.</span>
<span class="sd">    Returns:</span>
<span class="sd">        image grid object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nindex</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">nindex</span> <span class="o">//</span> <span class="n">nrows</span>
    <span class="k">if</span> <span class="n">nindex</span> <span class="o">!=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">[:</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">]</span>
        <span class="n">nindex</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span>

    <span class="c1"># want result.shape = (height*nrows, width*ncols, intensity)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">images</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
        <span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.utils.post_processing" class="doc doc-heading">
<code class="highlight language-python"><span class="n">post_processing</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Post processing for image.
un standarize image and multiply by 255.
Next clip values to [0, 255] and convert to uint8.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>image</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>image to post process.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>post processed image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">post_processing</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Post processing for image.</span>
<span class="sd">    un standarize image and multiply by 255.</span>
<span class="sd">    Next clip values to [0, 255] and convert to uint8.</span>
<span class="sd">    Args:</span>
<span class="sd">        image (np.ndarray): image to post process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        post processed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">IMAGENET_STANDARD_STD</span> <span class="o">+</span> <span class="n">IMAGENET_STANDARD_MEAN</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="mf">255.0</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">255.0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resize</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">resize</span><span class="p">,</span> <span class="n">resize</span><span class="p">))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="modules.utils.set_seed" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Set seed for random operations.</p>

      <details class="quote">
        <summary>Source code in <code>modules/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Set seed for random operations.&quot;&quot;&quot;</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="vqgan">VQGAN</h2>


<div class="doc doc-object doc-module">


<a id="modules.vqgan"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.GumbelQuantize" class="doc doc-heading">
        <code>GumbelQuantize</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Gumbel Softmax trick quantizer
Categorical Reparameterization with Gumbel-Softmax, Jang et al. 2016.
z (continuous) -&gt; z_q (discrete)
z.shape = (batch, height, width, channel)</p>

<details class="quantization-pipeline">
  <summary>quantization pipeline</summary>
  <ol>
<li>get encoder input (B,H,W,C)</li>
<li>get logits(prob) of input (B,H,W,n_embed)</li>
</ol>
</details>
<details class="see">
  <summary>See</summary>
  <p>https://arxiv.org/abs/1611.01144</p>
</details>
  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>

<details class="config-attributes">
  <summary>Config Attributes</summary>
  <p>n_embed (int) : number of embeddings.
emb_dim (int): dimension of embedding.
kl_weight (float): weight of kl loss.</p>
</details>

        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">GumbelQuantize</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gumbel Softmax trick quantizer</span>
<span class="sd">    Categorical Reparameterization with Gumbel-Softmax, Jang et al. 2016.</span>
<span class="sd">    z (continuous) -&gt; z_q (discrete)</span>
<span class="sd">    z.shape = (batch, height, width, channel)</span>
<span class="sd">    quantization pipeline:</span>
<span class="sd">        1. get encoder input (B,H,W,C)</span>
<span class="sd">        2. get logits(prob) of input (B,H,W,n_embed)</span>

<span class="sd">    See:</span>
<span class="sd">        https://arxiv.org/abs/1611.01144</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>

<span class="sd">    Config Attributes:</span>
<span class="sd">        n_embed (int) : number of embeddings.</span>
<span class="sd">        emb_dim (int): dimension of embedding.</span>
<span class="sd">        kl_weight (float): weight of kl loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Project the input to the embedding space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Embeddings (codebook)</span>
        <span class="n">init_embbeding</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
            <span class="n">scale</span><span class="o">=-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
            <span class="n">embedding_init</span><span class="o">=</span><span class="n">init_embbeding</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="c1"># project z to get logits</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># given logits, sample from the Gumbel-Softmax distribution</span>
        <span class="n">gumbel_rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_rng</span><span class="p">(</span><span class="s2">&quot;gumbel&quot;</span><span class="p">)</span>
        <span class="n">gumbels</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gumbel</span><span class="p">(</span><span class="n">gumbel_rng</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">indicies_prob</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">((</span><span class="n">logits</span> <span class="o">+</span> <span class="n">gumbels</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gumb_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># dummy op to init the weights, so we can access them below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">))</span>

        <span class="c1"># get quantized latent vectors</span>
        <span class="n">emb_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bhwp,pd-&gt;bhwd&quot;</span><span class="p">,</span> <span class="n">indicies_prob</span><span class="p">,</span> <span class="n">emb_weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># get indices [BxHxWxP] -&gt; [BxH*W]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">indicies_prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># compute the codebook_loss (q_loss)</span>
        <span class="n">qy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="n">q_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kl_weight</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qy</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># here we return the embeddings, indices and logits (for loss)</span>
        <span class="k">return</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_codebook_entry</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the codebook entry for a given index.</span>
<span class="sd">        Input is expected to be of shape (batch, num_tokens)&quot;&quot;&quot;</span>
        <span class="c1"># indices are expected to be of shape (batch, num_tokens)</span>
        <span class="c1"># get quantized latent vectors</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">emb_weights</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">emb_weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># z_q = self.embedding(indices) can&#39;t be used because of not accessibility of self.embedding</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z_q</span> <span class="o">=</span> <span class="n">z_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">z_q</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.GumbelQuantize.get_codebook_entry" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_codebook_entry</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the codebook entry for a given index.
Input is expected to be of shape (batch, num_tokens)</p>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_codebook_entry</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the codebook entry for a given index.</span>
<span class="sd">    Input is expected to be of shape (batch, num_tokens)&quot;&quot;&quot;</span>
    <span class="c1"># indices are expected to be of shape (batch, num_tokens)</span>
    <span class="c1"># get quantized latent vectors</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">emb_weights</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
    <span class="n">z_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">emb_weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># z_q = self.embedding(indices) can&#39;t be used because of not accessibility of self.embedding</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">z_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z_q</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.NLayerDiscriminator" class="doc doc-heading">
        <code>NLayerDiscriminator</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Defines a PatchGAN discriminator as in Pix2Pix</p>

<details class="see">
  <summary>See</summary>
  <p>https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix/blob/master/models/networks.py</p>
</details>
  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ndf</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>the number of filters in the last conv layer</p></td>
        </tr>
        <tr>
          <td><code>n_layers</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>the number of conv layers in the discriminator</p></td>
        </tr>
        <tr>
          <td><code>output_dim</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>dim of output the last channel of the discriminator</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32)</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">NLayerDiscriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a PatchGAN discriminator as in Pix2Pix</span>
<span class="sd">    See:</span>
<span class="sd">        https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix/blob/master/models/networks.py</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ndf (int): the number of filters in the last conv layer</span>
<span class="sd">        n_layers (int): the number of conv layers in the discriminator</span>
<span class="sd">        output_dim (bool): dim of output the last channel of the discriminator</span>
<span class="sd">        dtype: the dtype of the computation (default: float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ndf</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># input is bx256x256x(nc) return bx30x30x1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndf</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">leaky_relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">negative_slope</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1"># downsample</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">):</span>
            <span class="n">nf_mult</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ndf</span> <span class="o">*</span> <span class="n">nf_mult</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="n">use_running_average</span><span class="o">=</span><span class="ow">not</span> <span class="n">train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">leaky_relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">negative_slope</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># last downsample</span>
        <span class="n">nf_mult</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndf</span> <span class="o">*</span> <span class="n">nf_mult</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="n">use_running_average</span><span class="o">=</span><span class="ow">not</span> <span class="n">train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">leaky_relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">negative_slope</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># output 1 channel prediction map</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logits</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.VQGANPreTrainedModel" class="doc doc-heading">
        <code>VQGANPreTrainedModel</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="transformers.modeling_flax_utils.FlaxPreTrainedModel">FlaxPreTrainedModel</span></code></p>

  
      <p>An abstract class to handle weights initialization and a simple interface
for downloading and loading pretrained models.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>module_class</code></td>
          <td>
                <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code>
          </td>
          <td><p>a class derived from nn.Module
that defines the model's core computation.</p></td>
        </tr>
        <tr>
          <td><code>config_class</code></td>
          <td>
                <code><span title="transformers.PretrainedConfig">PretrainedConfig</span></code>
          </td>
          <td><p>a class derived from PretrainedConfig</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQGANPreTrainedModel</span><span class="p">(</span><span class="n">FlaxPreTrainedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An abstract class to handle weights initialization and a simple interface</span>
<span class="sd">    for downloading and loading pretrained models.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        module_class (nn.Module): a class derived from nn.Module</span>
<span class="sd">            that defines the model&#39;s core computation.</span>
<span class="sd">        config_class (PretrainedConfig): a class derived from PretrainedConfig</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">module_class</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span>
    <span class="n">config_class</span><span class="p">:</span> <span class="n">PretrainedConfig</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">PretrainedConfig</span> <span class="o">=</span> <span class="n">VQGANConfig</span><span class="p">(),</span>
        <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">_do_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (PretrainedConfig, optional): the config of the model. Defaults to VQGANConfig.</span>
<span class="sd">            input_shape (Tuple, optional): the input shape of the model.</span>
<span class="sd">                Defaults to (1, 256, 256, 3).</span>
<span class="sd">            seed (int, optional): the seed of the model. Defaults to 0.</span>
<span class="sd">            dtype (jnp.dtype, optional): the dtype of the computation. Defaults to jnp.float32.</span>
<span class="sd">            _do_init (bool, optional): whether to initialize the model. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> has to be an instance of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;module_class should be defined in derived classes&quot;</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_class</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">module</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">_do_init</span><span class="o">=</span><span class="n">_do_init</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the weights of the model. Get the params</span>

<span class="sd">        Args:</span>
<span class="sd">            rng (Union[Any,jnp.ndarray]): the random number generator.</span>
<span class="sd">            input_shape (Tuple): the input shape of the model.</span>
<span class="sd">            params (FrozenDict, optional): the params of the model. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            initialized params of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialize model</span>
        <span class="n">input_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">params_rng</span><span class="p">,</span> <span class="n">dropout_rng</span><span class="p">,</span> <span class="n">gumble_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params_rng</span><span class="p">,</span>
            <span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">,</span>
            <span class="s2">&quot;gumbel&quot;</span><span class="p">:</span> <span class="n">gumble_rng</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">random_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">input_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

        <span class="c1"># If params provided find unitialized params and replace with provided params</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random_params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">random_params</span><span class="p">))</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">freeze</span><span class="p">(</span><span class="n">unflatten_dict</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random_params</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pixel_values</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Encode the input.</span>
<span class="sd">        Args:</span>
<span class="sd">            pixel_values (jnp.ndarray): the input to the encoder.</span>
<span class="sd">            params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">            dropout_rng (Union[Any,jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">            gumble_rng (Union[Any,jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">            train (bool, optional): Training or inference mode. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle any PRNG if needed</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
            <span class="n">pixel_values</span><span class="p">,</span>
            <span class="ow">not</span> <span class="n">train</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">encode</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decode the latent vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            z (jnp.ndarray): the latent vector.</span>
<span class="sd">            params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">            dropout_rng (Union[Any,jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">            gumble_rng (Union[Any,jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">            train (bool, optional): Training or inference mode. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the decoded image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle any PRNG if needed</span>
        <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
            <span class="n">z</span><span class="p">,</span>
            <span class="ow">not</span> <span class="n">train</span><span class="p">,</span>
            <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">decode</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">z_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decode the indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            indices (jnp.ndarray): the indices.</span>
<span class="sd">            z_shape (Tuple[int, ...]): the shape of the latent vector.</span>
<span class="sd">            params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the decoded image from indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
            <span class="n">indices</span><span class="p">,</span>
            <span class="n">z_shape</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">decode_code</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the temperature of the model.</span>
<span class="sd">        Args:</span>
<span class="sd">            temperature (float): the temperature to update to.</span>
<span class="sd">            params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">        Returns:</span>
<span class="sd">            the updated temperature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
            <span class="n">temperature</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">update_temperature</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_temperature</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pixel_values</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Encode and decode the input.</span>

<span class="sd">        Args:</span>
<span class="sd">            pixel_values (jnp.ndarray): the input to the encoder.</span>
<span class="sd">            params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">            dropout_rng (Optional[jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">            gumble_rng (Optional[jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">                If gumble_rng is None then the defult rng is used and produce deterministic results.</span>
<span class="sd">            train (bool, optional): Training or inference mode. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">                the encoded latent vector,</span>
<span class="sd">                the decoded image,</span>
<span class="sd">                the log prob of the latent vector,</span>
<span class="sd">                the indices of the latent vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check dtype</span>
        <span class="n">pixel_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pixel_values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">pixel_values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">else</span> <span class="n">pixel_values</span>
        <span class="p">)</span>
        <span class="c1"># Handle any PRNG if needed</span>
        <span class="n">rngs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span> <span class="n">pixel_values</span><span class="p">,</span> <span class="ow">not</span> <span class="n">train</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gumble_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Encode and decode the input.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pixel_values</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the input to the encoder.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>]</code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dropout_rng</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the dropout rng. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gumble_rng</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the gumbel rng. Defaults to None.
If gumble_rng is None then the defult rng is used and produce deterministic results.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Training or inference mode. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the encoded latent vector,</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the decoded image,</p></td>
        </tr>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>the log prob of the latent vector,</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the indices of the latent vector.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pixel_values</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Encode and decode the input.</span>

<span class="sd">    Args:</span>
<span class="sd">        pixel_values (jnp.ndarray): the input to the encoder.</span>
<span class="sd">        params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">        dropout_rng (Optional[jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">        gumble_rng (Optional[jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">            If gumble_rng is None then the defult rng is used and produce deterministic results.</span>
<span class="sd">        train (bool, optional): Training or inference mode. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">            the encoded latent vector,</span>
<span class="sd">            the decoded image,</span>
<span class="sd">            the log prob of the latent vector,</span>
<span class="sd">            the indices of the latent vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check dtype</span>
    <span class="n">pixel_values</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pixel_values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">pixel_values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">else</span> <span class="n">pixel_values</span>
    <span class="p">)</span>
    <span class="c1"># Handle any PRNG if needed</span>
    <span class="n">rngs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span> <span class="n">pixel_values</span><span class="p">,</span> <span class="ow">not</span> <span class="n">train</span><span class="p">,</span> <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">VQGANConfig</span><span class="p">(),</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">_do_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><span title="transformers.PretrainedConfig">PretrainedConfig</span></code>
          </td>
          <td><p>the config of the model. Defaults to VQGANConfig.</p></td>
          <td>
                <code>VQGANConfig()</code>
          </td>
        </tr>
        <tr>
          <td><code>input_shape</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span></code>
          </td>
          <td><p>the input shape of the model.
Defaults to (1, 256, 256, 3).</p></td>
          <td>
                <code>(1, 256, 256, 3)</code>
          </td>
        </tr>
        <tr>
          <td><code>seed</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>the seed of the model. Defaults to 0.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation. Defaults to jnp.float32.</p></td>
          <td>
                <code>jnp.float32</code>
          </td>
        </tr>
        <tr>
          <td><code>_do_init</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to initialize the model. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">PretrainedConfig</span> <span class="o">=</span> <span class="n">VQGANConfig</span><span class="p">(),</span>
    <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="n">_do_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (PretrainedConfig, optional): the config of the model. Defaults to VQGANConfig.</span>
<span class="sd">        input_shape (Tuple, optional): the input shape of the model.</span>
<span class="sd">            Defaults to (1, 256, 256, 3).</span>
<span class="sd">        seed (int, optional): the seed of the model. Defaults to 0.</span>
<span class="sd">        dtype (jnp.dtype, optional): the dtype of the computation. Defaults to jnp.float32.</span>
<span class="sd">        _do_init (bool, optional): whether to initialize the model. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_class</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2"> has to be an instance of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;module_class should be defined in derived classes&quot;</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_class</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">module</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">_do_init</span><span class="o">=</span><span class="n">_do_init</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.decode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gumble_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Decode the latent vector.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>z</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the latent vector.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>]</code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dropout_rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the dropout rng. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gumble_rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the gumbel rng. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Training or inference mode. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the decoded image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode the latent vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        z (jnp.ndarray): the latent vector.</span>
<span class="sd">        params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">        dropout_rng (Union[Any,jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">        gumble_rng (Union[Any,jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">        train (bool, optional): Training or inference mode. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        the decoded image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle any PRNG if needed</span>
    <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="p">)</span>
    <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
        <span class="n">z</span><span class="p">,</span>
        <span class="ow">not</span> <span class="n">train</span><span class="p">,</span>
        <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">decode</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.decode_code" class="doc doc-heading">
<code class="highlight language-python"><span class="n">decode_code</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">z_shape</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Decode the indices.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>indices</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the indices.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>z_shape</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[int, ...]</code>
          </td>
          <td><p>the shape of the latent vector.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>]</code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the decoded image from indices.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode_code</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">z_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode the indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        indices (jnp.ndarray): the indices.</span>
<span class="sd">        z_shape (Tuple[int, ...]): the shape of the latent vector.</span>
<span class="sd">        params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        the decoded image from indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
        <span class="n">indices</span><span class="p">,</span>
        <span class="n">z_shape</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">decode_code</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.encode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">encode</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gumble_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Encode the input.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pixel_values</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the input to the encoder.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>]</code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dropout_rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the dropout rng. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gumble_rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the gumbel rng. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Training or inference mode. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pixel_values</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dropout_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gumble_rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Encode the input.</span>
<span class="sd">    Args:</span>
<span class="sd">        pixel_values (jnp.ndarray): the input to the encoder.</span>
<span class="sd">        params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">        dropout_rng (Union[Any,jnp.ndarray], optional): the dropout rng. Defaults to None.</span>
<span class="sd">        gumble_rng (Union[Any,jnp.ndarray], optional): the gumbel rng. Defaults to None.</span>
<span class="sd">        train (bool, optional): Training or inference mode. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle any PRNG if needed</span>
    <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">}</span> <span class="k">if</span> <span class="n">dropout_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="p">)</span>
    <span class="n">rngs</span><span class="p">[</span><span class="s2">&quot;gumbel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gumble_rng</span> <span class="k">if</span> <span class="n">gumble_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
        <span class="n">pixel_values</span><span class="p">,</span>
        <span class="ow">not</span> <span class="n">train</span><span class="p">,</span>
        <span class="n">rngs</span><span class="o">=</span><span class="n">rngs</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">encode</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.init_weights" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init_weights</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the weights of the model. Get the params</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>rng</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Any">Any</span>, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the random number generator.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_shape</code></td>
          <td>
                <code><span title="typing.Tuple">Tuple</span></code>
          </td>
          <td><p>the input shape of the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span></code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td><p>initialized params of the model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the weights of the model. Get the params</span>

<span class="sd">    Args:</span>
<span class="sd">        rng (Union[Any,jnp.ndarray]): the random number generator.</span>
<span class="sd">        input_shape (Tuple): the input shape of the model.</span>
<span class="sd">        params (FrozenDict, optional): the params of the model. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        initialized params of the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize model</span>
    <span class="n">input_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">params_rng</span><span class="p">,</span> <span class="n">dropout_rng</span><span class="p">,</span> <span class="n">gumble_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">rngs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params_rng</span><span class="p">,</span>
        <span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="n">dropout_rng</span><span class="p">,</span>
        <span class="s2">&quot;gumbel&quot;</span><span class="p">:</span> <span class="n">gumble_rng</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">random_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">input_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

    <span class="c1"># If params provided find unitialized params and replace with provided params</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random_params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">random_params</span><span class="p">))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">missing_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">freeze</span><span class="p">(</span><span class="n">unflatten_dict</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random_params</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQGANPreTrainedModel.update_temperature" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_temperature</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update the temperature of the model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>temperature</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>the temperature to update to.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="flax.core.frozen_dict.FrozenDict">FrozenDict</span>]</code>
          </td>
          <td><p>the params of the model. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>the updated temperature.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Update the temperature of the model.</span>
<span class="sd">    Args:</span>
<span class="sd">        temperature (float): the temperature to update to.</span>
<span class="sd">        params (Optional[FrozenDict], optional): the params of the model. Defaults to None.</span>
<span class="sd">    Returns:</span>
<span class="sd">        the updated temperature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">},</span>
        <span class="n">temperature</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">update_temperature</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">new_temperature</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.VQGanDiscriminator" class="doc doc-heading">
        <code>VQGanDiscriminator</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="transformers.modeling_flax_utils.FlaxPreTrainedModel">FlaxPreTrainedModel</span></code></p>

  
      <p>VQGAN discriminator model.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>module_class</code></td>
          <td>
                <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code>
          </td>
          <td><p>the discriminator module class (NLayerDiscriminator).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQGanDiscriminator</span><span class="p">(</span><span class="n">FlaxPreTrainedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;VQGAN discriminator model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        module_class (nn.Module): the discriminator module class (NLayerDiscriminator).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">module_class</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">NLayerDiscriminator</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DiscConfig</span> <span class="o">=</span> <span class="n">DiscConfig</span><span class="p">(),</span>
        <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">_do_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_class</span><span class="p">(</span>
            <span class="n">ndf</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ndf</span><span class="p">,</span>
            <span class="n">n_layers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">output_last_dim</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">module</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">_do_init</span><span class="o">=</span><span class="n">_do_init</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_rng</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># initialize model</span>
        <span class="n">input_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">random_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">params_rng</span><span class="p">,</span> <span class="n">input_x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># If params provided find unitialized params and replace with provided params</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random_params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">random_params</span><span class="p">))</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">unfreeze</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">missing_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_params</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">freeze</span><span class="p">(</span><span class="n">unflatten_dict</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random_params</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_stats</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="c1"># Handle any PRNG if needed</span>
        <span class="k">if</span> <span class="n">batch_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span> <span class="s2">&quot;batch_stats&quot;</span><span class="p">:</span> <span class="n">batch_stats</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">batch_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_stats&quot;</span><span class="p">:</span> <span class="n">batch_stats</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span> <span class="s2">&quot;batch_stats&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
                <span class="s2">&quot;batch_stats&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">dict_params</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;batch_stats&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.VQModel" class="doc doc-heading">
        <code>VQModel</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="modules.vqgan.VQGANPreTrainedModel" href="#modules.vqgan.VQGANPreTrainedModel">VQGANPreTrainedModel</a></code></p>

  
      <p>VQ-VAE model from pre-trained VQGAN.</p>


        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQModel</span><span class="p">(</span><span class="n">VQGANPreTrainedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;VQ-VAE model from pre-trained VQGAN.&quot;&quot;&quot;</span>

    <span class="n">module_class</span> <span class="o">=</span> <span class="n">VQModule</span>  <span class="c1"># type: ignore</span>
    <span class="n">config_class</span> <span class="o">=</span> <span class="n">VQGANConfig</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.VQModule" class="doc doc-heading">
        <code>VQModule</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>VQ-VAE module.</p>

<details class="see">
  <summary>See</summary>
  <p>https://arxiv.org/abs/1711.00937v2</p>
</details>
  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation (default: float32).</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VQModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;VQ-VAE module.</span>
<span class="sd">    See:</span>
<span class="sd">        https://arxiv.org/abs/1711.00937v2</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation (default: float32).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the VQ-VAE module.&quot;&quot;&quot;</span>
        <span class="c1"># Set activation function</span>
        <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">ACTFUN</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">act_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># Encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">act_fn</span><span class="o">=</span><span class="n">act_fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># Map last channel of encoder to embedding dim for VQ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_quantizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Which quantizer to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VectorQuantizer</span><span class="p">,</span> <span class="n">GumbelQuantize</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_gumbel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span> <span class="o">=</span> <span class="n">GumbelQuantize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span> <span class="o">=</span> <span class="n">VectorQuantizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># Map last channel of VQ to z channels dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">z_channels</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">act_fn</span><span class="o">=</span><span class="n">act_fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Encode the input.</span>
<span class="sd">        Args:</span>
<span class="sd">            x (jnp.ndarray): the input to the encoder.</span>
<span class="sd">        Returns:</span>
<span class="sd">            the encoded input, the loss and the indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Encoder</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="c1"># Pre-quantizer</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_quantizer</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># Quantizer</span>
        <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># Post-quantizer</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span><span class="p">(</span><span class="n">z_q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_q</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decode the quantized latent vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            z_q (jnp.ndarray): the quantized latent vector.</span>
<span class="sd">            deterministic (bool, optional): for Dropout. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the reconstructed image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Post-quantizer</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span><span class="p">(</span><span class="n">z_q</span><span class="p">)</span>
        <span class="c1"># Decoder</span>
        <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_recon</span>

    <span class="k">def</span> <span class="nf">decode_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">z_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decode already created z_code&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantizer&quot;</span><span class="p">]</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">get_codebook_entry</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">z_shape</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the temperature of the Gumbel-Softmax distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            temperature (float): the new temperature of the Gumbel-Softmax distribution</span>
<span class="sd">        Returns:</span>
<span class="sd">            the new temperature of the Gumbel-Softmax distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gumb_temp</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gumb_temp</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_recon</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQModule.decode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">decode</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Decode the quantized latent vector.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>z_q</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the quantized latent vector.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>deterministic</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>for Dropout. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the reconstructed image.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_q</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode the quantized latent vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        z_q (jnp.ndarray): the quantized latent vector.</span>
<span class="sd">        deterministic (bool, optional): for Dropout. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        the reconstructed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Post-quantizer</span>
    <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span><span class="p">(</span><span class="n">z_q</span><span class="p">)</span>
    <span class="c1"># Decoder</span>
    <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_recon</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQModule.decode_code" class="doc doc-heading">
<code class="highlight language-python"><span class="n">decode_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">z_shape</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Decode already created z_code</p>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">decode_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">z_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode already created z_code&quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantizer&quot;</span><span class="p">]</span>
    <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">get_codebook_entry</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">z_shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z_q</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQModule.encode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Encode the input.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>the input to the encoder.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[<span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>, float, <span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span>]</code>
          </td>
          <td><p>the encoded input, the loss and the indices.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Encode the input.</span>
<span class="sd">    Args:</span>
<span class="sd">        x (jnp.ndarray): the input to the encoder.</span>
<span class="sd">    Returns:</span>
<span class="sd">        the encoded input, the loss and the indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Encoder</span>
    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">)</span>
    <span class="c1"># Pre-quantizer</span>
    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_quantizer</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="c1"># Quantizer</span>
    <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="c1"># Post-quantizer</span>
    <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span><span class="p">(</span><span class="n">z_q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">indices</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQModule.setup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setup</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Setup the VQ-VAE module.</p>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup the VQ-VAE module.&quot;&quot;&quot;</span>
    <span class="c1"># Set activation function</span>
    <span class="n">act_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">ACTFUN</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">act_name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
    <span class="c1"># Encoder</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">act_fn</span><span class="o">=</span><span class="n">act_fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="c1"># Map last channel of encoder to embedding dim for VQ</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pre_quantizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Which quantizer to use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">VectorQuantizer</span><span class="p">,</span> <span class="n">GumbelQuantize</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_gumbel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span> <span class="o">=</span> <span class="n">GumbelQuantize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span> <span class="o">=</span> <span class="n">VectorQuantizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="c1"># Map last channel of VQ to z channels dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_quantizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">z_channels</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;VALID&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Decoder</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">act_fn</span><span class="o">=</span><span class="n">act_fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VQModule.update_temperature" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_temperature</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update the temperature of the Gumbel-Softmax distribution.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>temperature</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>the new temperature of the Gumbel-Softmax distribution</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>float</code>
          </td>
          <td><p>the new temperature of the Gumbel-Softmax distribution</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Update the temperature of the Gumbel-Softmax distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        temperature (float): the new temperature of the Gumbel-Softmax distribution</span>
<span class="sd">    Returns:</span>
<span class="sd">        the new temperature of the Gumbel-Softmax distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gumb_temp</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantizer</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gumb_temp</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="modules.vqgan.VectorQuantizer" class="doc doc-heading">
        <code>VectorQuantizer</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="flax.linen">nn</span>.<span title="flax.linen.Module">Module</span></code></p>

  
      <p>Discretization bottleneck part of the VQ-VAE.
Module get z lattent vector (Encoder output)
and maps it to a discrete one-hot vector
that is the index of the closest embedding vector e_j
z (continuous) -&gt; z_q (discrete)
z.shape = (batch, height, width, channel)</p>

<details class="quantization-pipeline">
  <summary>quantization pipeline</summary>
  <ol>
<li>get encoder input (B,H,W,C)</li>
<li>flatten input to (B<em>H</em>W,C)</li>
</ol>
</details>
<details class="see">
  <summary>See</summary>
  <p>https://github.com/MishaLaskin/vqvae/blob/d761a999e2267766400dc646d82d3ac3657771d4/models/quantizer.py</p>
</details>
  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="modules.config.VQGANConfig" href="#modules.config.VQGANConfig">VQGANConfig</a></code>
          </td>
          <td><p>the config of the model.</p></td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.dtype">dtype</span></code>
          </td>
          <td><p>the dtype of the computation for embeddings (default: float32).</p></td>
        </tr>
    </tbody>
  </table>

<details class="config-attributes">
  <summary>Config Attributes</summary>
  <p>n_embed (int) : number of embeddings.
emb_dim (int): dimension of embedding.
beta (float): weight of commitment loss.</p>
</details>

        <details class="quote">
          <summary>Source code in <code>modules/vqgan.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VectorQuantizer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discretization bottleneck part of the VQ-VAE.</span>
<span class="sd">    Module get z lattent vector (Encoder output)</span>
<span class="sd">    and maps it to a discrete one-hot vector</span>
<span class="sd">    that is the index of the closest embedding vector e_j</span>
<span class="sd">    z (continuous) -&gt; z_q (discrete)</span>
<span class="sd">    z.shape = (batch, height, width, channel)</span>
<span class="sd">    quantization pipeline:</span>
<span class="sd">        1. get encoder input (B,H,W,C)</span>
<span class="sd">        2. flatten input to (B*H*W,C)</span>

<span class="sd">    See:</span>
<span class="sd">        https://github.com/MishaLaskin/vqvae/blob/d761a999e2267766400dc646d82d3ac3657771d4/models/quantizer.py</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (VQGANConfig): the config of the model.</span>
<span class="sd">        dtype (jnp.dtype): the dtype of the computation for embeddings (default: float32).</span>

<span class="sd">    Config Attributes:</span>
<span class="sd">        n_embed (int) : number of embeddings.</span>
<span class="sd">        emb_dim (int): dimension of embedding.</span>
<span class="sd">        beta (float): weight of commitment loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">VQGANConfig</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">init_embbeding</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
            <span class="n">scale</span><span class="o">=-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_embed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
            <span class="n">embedding_init</span><span class="o">=</span><span class="n">init_embbeding</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="c1"># flatten z</span>
        <span class="n">z_flatten</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">)</span>

        <span class="c1"># dummy op to init the weights, so we can access them below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">))</span>

        <span class="c1"># distances from z to embeddings e_j (z - e)^2 = z^2 + e^2 - 2 e * z</span>
        <span class="n">emb_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z_flatten</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">emb_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z_flatten</span><span class="p">,</span> <span class="n">emb_weights</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># get quantized latent vectors</span>
        <span class="n">min_encoding_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">min_encoding_indices</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># reshape to (batch, num_tokens)</span>
        <span class="n">min_encoding_indices</span> <span class="o">=</span> <span class="n">min_encoding_indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># compute the codebook_loss (q_loss)</span>
        <span class="n">q_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">z_q</span><span class="p">)</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="p">(</span><span class="n">z_q</span> <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># here we return the embeddings and indices</span>
        <span class="k">return</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">q_loss</span><span class="p">,</span> <span class="n">min_encoding_indices</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_codebook_entry</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the codebook entry for a given index.</span>
<span class="sd">        Input is expected to be of shape (batch, num_tokens)&quot;&quot;&quot;</span>
        <span class="c1"># indices are expected to be of shape (batch, num_tokens)</span>
        <span class="c1"># get quantized latent vectors</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">emb_weights</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">emb_weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># z_q = self.embedding(indices) can&#39;t be used because of not accessibility of self.embedding</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z_q</span> <span class="o">=</span> <span class="n">z_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">z_q</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="modules.vqgan.VectorQuantizer.get_codebook_entry" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_codebook_entry</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the codebook entry for a given index.
Input is expected to be of shape (batch, num_tokens)</p>

      <details class="quote">
        <summary>Source code in <code>modules/vqgan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_codebook_entry</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the codebook entry for a given index.</span>
<span class="sd">    Input is expected to be of shape (batch, num_tokens)&quot;&quot;&quot;</span>
    <span class="c1"># indices are expected to be of shape (batch, num_tokens)</span>
    <span class="c1"># get quantized latent vectors</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">emb_weights</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">][</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>
    <span class="n">z_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">emb_weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># z_q = self.embedding(indices) can&#39;t be used because of not accessibility of self.embedding</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">z_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z_q</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../how-to-guides/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How-To Guides 📚" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              How-To Guides 📚
            </div>
          </div>
        </a>
      
      
        
        <a href="../explanation/" class="md-footer__link md-footer__link--next" aria-label="Next: Explanation 🤯" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Explanation 🤯
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>